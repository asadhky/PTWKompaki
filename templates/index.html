<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Kompaki</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="static/css/style.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        /* Existing CSS from index.html */

        body {
            font-family: 'Roboto', sans-serif;
            font-weight: 800;
        }
        .category {
            cursor: pointer;
            background-color: #f0f0f0;
        }

        .category:hover {
            background-color: #f0f0f0;
        }

        .editable {
            border: 1px solid #ddd;
            padding: 5px;
        }

        /* Existing CSS */
        .container {
            background-color: #5f6368;
            display: flex;
            flex-direction: column;
            padding: 20px;
            gap: 20px;
            /* 增加每部分之间的间距 */
        }

        .section {
            background-color: #333;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);

            width: 90%;      /* Slightly less wide (10% padding on sides) */
            margin: 0 auto;  /* Center the section horizontally */
        }

        h2 {
            margin-top: 0;
        }

        .form-group-inline {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .form-group-inline label {
            margin: 0;
            white-space: nowrap;
            /* 确保标签不会换行 */
        }

        .form-group-inline input {
            flex: 2;
            padding: 10px;
            border-radius: 4px;
            min-width: 0;
            /* 确保输入框不会超出父容器 */
        }

        .form-group-inline button {
            flex: 1;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            background-color: #4CAF50;
            color: #fff;
            cursor: pointer;
            white-space: nowrap;
            /* 确保按钮文字不会换行 */
        }

        .axis-container {
            display: flex;
            justify-content: space-around;
            margin-bottom: 8px;
            max-width: 100%; /* Prevent overflow on zoom */
        }

        .axis {
            background-color: #424242;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            width: 30%;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .rangetitles {
            background-color: #424242;
            padding: 20px;
            padding-bottom: 0;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            width: 48%;
            cursor: pointer;
            transition: background-color 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.4); /* Subtle shadow */
        }

        .axis {
            transition: background-color 0.8s ease, color 0.8s ease; 
        }

        .axis h2 {
            margin-top: 0;

        }

        .axis.selected {
            background-color: #50727b !important; /* Keeps the background color when selected */
            color: #fff !important; /* Changes text color to white */
        }

        .axis.selected h2, 
        .axis.selected div {
            color: #fff !important; /* Ensures all text inside the selected axis is white */
        }


        .slider-container {
            display: flex;
            align-items: center;
            /* margin-bottom: 10px; */
        }

        .slider-container label {
            margin-right: 10px;
            white-space: nowrap;
        }

        .slider-container input {
            flex-grow: 1;
        }

        .terminal-output {
            margin-top: 20px;
            padding: 10px;
            background-color: #333;
            color: #d3d3d3;
            height: 200px;
            overflow-y: auto;
            border-radius: 5px;
        }

        .langBtn {
            cursor: pointer;
            border-radius: 5px;
            text-decoration: none;
        }
        .langBtn img {
            width: 20px;
            height: 20px;
        }

        .icon-container {
            display: flex;
            justify-content: center; /* Centers the content horizontally */
            align-items: center; /* Centers the content vertically (if needed) */
            width: 100%; /* Ensures the container takes up full width */
        }



        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }


    </style>


</head>

<body>
    <!-- Top navigation bar -->
    {% include 'navBar.html' %}
    {% include 'sidebar.html' %}

    <!-- Assuming you have a top bar where the categories will go -->
    <!-- <div class="top-categories" id="categories">
        <div class="category" id="category-individualworkflow">Individual Workflow</div>
        <div class="category" id="category-planning">Planning</div>
        <div class="category" id="category-machining">Machining</div>
        <div class="category" id="category-monitoring">Monitoring</div>
        <div class="category" id="category-community">Community</div>
        <div class="category" id="category-development">Development</div>
        <div class="category" id="category-utility">Utility</div>
        <div class="app-category-item add-category" onclick="addCategory()">
            <span class="add-category-icon">+</span>
        </div>
        <style>
            .add-category {border-radius: 5px;}
            .add-category:hover {
            background-color: #e0e0e0;
            transition: background-color 0.3s ease;
            
            }
        </style>
        </style>
    </div> -->

    <!-- Middle section for axis status -->
    <div class="axis-status" id="axis-status">
        <div class="container">
            <!-- 上部：Connection -->
            <!-- <div class="section" id="connection-section">
                <h2 data-key="title-connection" style="color: #b3b3b3;">Connection</h2>
                <div class="form-group-inline">
                    <label for="amsnetid" data-key="label-amsnetid" style="color: #d3d3d3;">AmsNetID</label>
                    <input type="text" id="amsnetid">
                    <label for="port" data-key="label-port" style="color: #d3d3d3;">Port</label>
                    <input type="text" id="port">
                    <button id="open-port-btn" data-key="button-open-port">Open Port</button>
                </div>
            </div> -->

            <!-- 中部：Axis Status -->
            <div class="section" id="axis-status-section">
                <div class="header-container"> 
                    <h2 data-key="title-axis-status" style="color: #b3b3b3;">Axis Status</h2> 
                    <button class="reset-axis-btn" id="reset-axis-btn">Reset Axis</button> 
                </div>
                <div class="axis-container">
                    <!-- X Axis -->
                    <div class="axis" id="status-x-axis" onclick="selectAxis('x')">
                        <div class="axis-header">
                            <h2 data-key="title-x-axis" style="color: #b3b3b3;">X Axis</h2>
                            <button class="edit-axis-button" id="edit-axis-x">
                                <img src="{{ url_for('static', filename='edit1.png') }}" alt="Edit Axis" class="button-icon">
                            </button>
                        </div>
                        <div class="axis-controls button-group">
                            <button class="arrow-button fast-button" onclick="moveAxis('x', 'fast-left')"><img src="{{ url_for('static', filename='fast-backward.png') }}" alt="Fast Left" class="button-icon"></button>
                            <button class="arrow-button" onclick="moveAxis('x', 'left')"><img src="{{ url_for('static', filename='left.png') }}" alt="Left Arrow" class="button-icon"></button>
                            <button class="arrow-button" onclick="moveAxis('x', 'right')"><img src="{{ url_for('static', filename='right.png') }}" alt="Right Arrow" class="button-icon"></button>
                            <button class="arrow-button fast-button" onclick="moveAxis('x', 'fast-right')"><img src="{{ url_for('static', filename='fast-forward.png') }}" alt="Fast Right" class="button-icon"></button>
                            <button class="arrow-button" onclick="resetAxis('x')"><img src="{{ url_for('static', filename='stop-button.png') }}" alt="StopButton" class="button-icon"></button> <!-- Reset button -->
                            
                        </div>
                        
                        <div data-key="label-current-position" style="color: #d3d3d3;">Current Position: <span id="x-current">0.00</span></div>
                        <div data-key="label-end-position" style="color: #d3d3d3;">End Position: <span id="x-end">0.00</span></div>
                        
                    </div>
                    <!-- Edit X Axis Dialog -->
                    <div id="edit-dialog1" class="edit-dialog hidden">
                        <div class="modal-card bg-zinc-800 text-white rounded-lg p-8 w-96">
                        <div class="modal-header flex justify-between items-center">
                            <h2 class="text-xl">Edit X Axis</h2>
                            <button class="newclosebutton" style="background: transparent; border: none; color: gray;font-size: 28px; font-weight: bold; cursor: pointer; padding-bottom: 25px;" onclick="closeEditDialog()">&times;</button>
                        </div>
                        <div class="modal-body mt-4 space-y-4">
                            <div>
                                <button class="reset-axis-btn" id="enable-axis-x" onclick="toggleAxis('x')">Enable</button>
                            </div>
                            <!-- <div class="flex flex-col">
                            <label for="speed" class="text-sm mb-1" data-key="label-speed">Current Position</label>
                            <input
                                type="number"
                                id="speed-x"
                                placeholder="Enter speed"
                                class="p-2 bg-gray-700 text-white rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none"
                            />
                            <button id="set-speed-x" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md mt-2" onclick="setSpeedX()">Set Current</button>
                            </div> -->
                            <div class="flex flex-col">
                            <label for="position" class="text-sm mb-1" data-key="label-position">End Position</label>
                            <input
                                type="number"
                                id="position-x"
                                placeholder="Enter position"
                                class="p-2 bg-gray-700 text-white rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none"
                            />
                            <button id="set-position-x" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md mt-2" onclick="setPositionX()">Set End</button>
                            </div>
                        </div>
                        </div>
                    </div>
  
                    <!-- Y Axis -->
                    <div class="axis" id="status-y-axis" onclick="selectAxis('y')">
                        <div class="axis-header">
                            <h2 data-key="title-y-axis" style="color: #b3b3b3;">Y Axis</h2>
                            <button class="edit-axis-button" id="edit-axis-y">
                                <img src="{{ url_for('static', filename='edit1.png') }}" alt="Edit Axis" class="button-icon">
                            </button>                        </div>
                        <div class="axis-controls button-group">
                            <button class="arrow-button fast-button" onclick="moveAxis('y', 'fast-up-left')">    <img src="{{ url_for('static', filename='fastdiagleft.png') }}" alt="Fast Diag Left" class="button-icon"></button>
                            <button class="arrow-button" onclick="moveAxis('y', 'up-left')"><img src="{{ url_for('static', filename='diagleft.png') }}" alt="Diag Left Arrow" class="button-icon"></button>
                            <button class="arrow-button" onclick="moveAxis('y', 'down-right')"><img src="{{ url_for('static', filename='diagright.png') }}" alt="Diag Right Arrow" class="button-icon"></button>
                            <button class="arrow-button fast-button" onclick="moveAxis('y', 'fast-down-right')"><img src="{{ url_for('static', filename='fastdiagright.png') }}" alt="Fast Diag Right" class="button-icon"></button>

                            <button class="arrow-button" onclick="resetAxis('y')"><img src="{{ url_for('static', filename='stop-button.png') }}" alt="StopButton" class="button-icon"></button> <!-- Reset button -->

                        </div>
                        <div data-key="label-current-position" style="color: #d3d3d3;">Current Position: <span id="y-current">0.00</span></div>
                        <div data-key="label-end-position" style="color: #d3d3d3;">End Position: <span id="y-end">0.00</span></div>
                        
                    </div>
                    <!-- Edit Y Axis Dialog -->
                    <div id="edit-dialog2" class="edit-dialog hidden">
                        <div class="modal-card bg-zinc-800 text-white rounded-lg p-8 w-96">
                        <div class="modal-header flex justify-between items-center">
                            <h2 class="text-xl">Edit Y Axis</h2>
                            <button class="newclosebutton" style="background: transparent; border: none; color: gray;font-size: 28px; font-weight: bold; cursor: pointer; padding-bottom: 25px;" onclick="closeEditDialogY()">&times;</button>
                        </div>
                        <div class="modal-body mt-4 space-y-4">
                            <div>
                                <button class="reset-axis-btn" id="enable-axis-y" onclick="toggleAxis('y')">Enable</button>
                            </div>
                            <!-- <div class="flex flex-col">
                            <label for="speed" class="text-sm mb-1" data-key="label-speed">Current Position</label>
                            <input
                                type="number"
                                id="speed-y"
                                placeholder="Enter speed"
                                class="p-2 bg-gray-700 text-white rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none"
                            />
                            <button id="set-speed-y" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md mt-2" onclick="setSpeedY()">Set Current</button>
                            </div> -->
                            <div class="flex flex-col">
                            <label for="position" class="text-sm mb-1" data-key="label-position">End Position</label>
                            <input
                                type="number"
                                id="position-y"
                                placeholder="Enter position"
                                class="p-2 bg-gray-700 text-white rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none"
                            />
                            <button id="set-position-y" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md mt-2" onclick="setPositionY()">Set End</button>
                            </div>
                        </div>
                        </div>
                    </div>

                    <!-- Z Axis -->
                    <div class="axis" id="status-z-axis" onclick="selectAxis('z')">
                        <div class="axis-header">
                            <h2 data-key="title-z-axis" style="color: #b3b3b3;">Z Axis</h2>
                            <button class="edit-axis-button" id="edit-axis-z">
                                <img src="{{ url_for('static', filename='edit1.png') }}" alt="Edit Axis" class="button-icon">
                            </button>                        </div>
                        <div class="axis-controls button-group">
                            <button class="arrow-button fast-button" onclick="moveAxis('z', 'fast-up')"><img src="{{ url_for('static', filename='fastup.png') }}" alt="Fast Up" class="button-icon"></button>
                            <button class="arrow-button" onclick="moveAxis('z', 'up')"><img src="{{ url_for('static', filename='uparrow.png') }}" alt="Up Arrow" class="button-icon"></button>
                            <button class="arrow-button" onclick="moveAxis('z', 'down')"><img src="{{ url_for('static', filename='downarrow.png') }}" alt="Down Arrow" class="button-icon"></button>
                            <button class="arrow-button fast-button" onclick="moveAxis('z', 'fast-down')"><img src="{{ url_for('static', filename='fastdown.png') }}" alt="Fast Down" class="button-icon"></button>
                            <button class="arrow-button" onclick="resetAxis('z')"><img src="{{ url_for('static', filename='stop-button.png') }}" alt="StopButton" class="button-icon"></button> <!-- Reset button -->

                        </div>
                        <div data-key="label-current-position" style="color: #d3d3d3;">Current Position: <span id="z-current">0.00</span></div>
                        <div data-key="label-end-position" style="color: #d3d3d3;">End Position: <span id="z-end">0.00</span></div>
                        
                    </div>
                    <!-- Edit Z Axis Dialog -->
                    <div id="edit-dialog3" class="edit-dialog hidden">
                        <div class="modal-card bg-zinc-800 text-white rounded-lg p-8 w-96">
                        <div class="modal-header flex justify-between items-center">
                            <h2 class="text-xl">Edit Z Axis</h2>
                            <button class="newclosebutton" style="background: transparent; border: none; color: gray;font-size: 28px; font-weight: bold; cursor: pointer; padding-bottom: 25px;" onclick="closeEditDialogZ()">&times;</button>
                        </div>
                        <div class="modal-body mt-4 space-y-4">
                            <div>
                                <button class="reset-axis-btn" id="enable-axis-z" onclick="toggleAxis('z')">Enable</button>
                            </div>
                            <!-- <div class="flex flex-col">
                            <label for="speed" class="text-sm mb-1" data-key="label-speed">Current Position</label>
                            <input
                                type="number"
                                id="speed-z"
                                placeholder="Enter speed"
                                class="p-2 bg-gray-700 text-white rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none"
                            />
                            <button id="set-speed-z" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md mt-2" onclick="setSpeedZ()">Set Current</button>
                            </div> -->
                            <div class="flex flex-col">
                            <label for="position" class="text-sm mb-1" data-key="label-position">End Position</label>
                            <input
                                type="number"
                                id="position-z"
                                placeholder="Enter position"
                                class="p-2 bg-gray-700 text-white rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none"
                            />
                            <button id="set-position-z" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md mt-2" onclick="setPositionZ()">Set End</button>
                            </div>
                        </div>
                        </div>
                    </div>
                </div>
                
                
                       
                                
            </div>
            
            
                <!-- <div id="axis-controls" style="display:none;" class="form-group-inline">

                    <button id="enable-axis-x" onclick="toggleAxis('x')">Enable X Axis</button>
                    <button id="enable-axis-y" onclick="toggleAxis('y')">Enable Y Axis</button>
                    <button id="enable-axis-z" onclick="toggleAxis('z')">Enable Z Axis</button>
                    <button class="reset-axis-btn" id="enable-axis-x" onclick="toggleAxis('x')">Enable</button>
                    <label for="speed" data-key="label-speed">Current Position</label>
                    <input type="number" id="speed" placeholder="Enter speed">
                    <button id="set-speed" data-key="button-set-speed">Set Current</button>
                    <label for="position" data-key="label-position">End Position</label>
                    <input type="number" id="position" placeholder="Enter position">
                    <button id="set-position" data-key="button-set-position">Set End</button>
                </div> -->

            
                <div class="section">
                    <div class="axis-container">
                        <div class="rangetitles" id="terminal-section">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <h2 data-key="label-override" style="color: #b3b3b3; margin-right: 20px;">Select Forward Speed</h2>
                                <div style="display: flex; gap: 10px;">
                                    <!-- Button and Text Group -->
                                    <div style="display: inline-block; text-align: center;">
                                        <button id="override-start-button" class="overridestartbutton" style="background-image: url('../static/overridestart.jpg');"></button>
                                        <div style="color: #b3b3b3; font-size: 14px;">OFF</div>
                                    </div>
                                    <div style="display: inline-block; text-align: center;">
                                        <button id="override-stop-button" class="overridestartbutton" style="background-image: url('../static/overridestop.jpg');"></button>
                                        <div style="color: #b3b3b3; font-size: 14px;">ON</div>
                                    </div>
                                </div>
                            </div>
                            

                            
                            <div class="slider-ui color1">
                                <input type="range" id="override-slider" min="0" max="100" step="1" value="{{ forward_speed }}">
                                <div class="bar">
                                    <span class="min"></span>
                                    <span class="max"></span>
                                </div>
                                <div class="track">
                                    <div class="value" id="override-value">{{ forward_speed }}</div>
                                </div>
                            </div>
                            <div class="icon-container">
                                <img src="{{ url_for('static', filename='spindlespeed.png') }}" alt="image" style="width: 80px;">
                            </div>
                            
                            
                        </div>
                        <div class="rangetitles" id="terminal-section">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <h2 data-key="label-spindle" style="color: #b3b3b3; display: inline-block;">Select Spindle Speed</h2>
                                <div style="display: flex; gap: 10px;">
                                    <label for="reverse-checkbox" style="color: #b3b3b3; margin-left: 15px;  margin-top: 15px;">
                                        <input type="checkbox" id="reverse-checkbox" onclick="toggleReverse()" style="margin-right: 5px;">
                                        Reverse
                                    </label> 
                                    <div style="display: inline-block; text-align: center;">                      
                                        <button id="spindle-start-button" class="spindlestartbutton" style="background-image: url('../static/spindlestart.jpg');"></button>
                                        <div style="color: #b3b3b3; font-size: 14px;">OFF</div>
                                    </div>  
                                    <div style="display: inline-block; text-align: center;"> 
                                        <button id="spindle-stop-button" class="spindlestartbutton" style="background-image: url('../static/spindlestop.jpg');"></button>
                                        <div style="color: #b3b3b3; font-size: 14px;">ON</div>
                                    </div>
                                </div>
                            </div>
                            <div class="slider-ui color1">
                                <input type="range" id="spindle-slider" min="0" max="100" step="1" value="{{ spindle_speed }}">
                                <div class="bar">
                                    <span class="min"></span>
                                    <span class="max"></span>
                                </div>
                                <div class="track">
                                    <div class="value" id="spindle-value">{{ spindle_speed }}</div>
                                </div>
                            </div>
                            <div class="icon-container">
                                <img src="{{ url_for('static', filename='override.png') }}" alt="image" style="width: 80px;">
                            </div>
                        </div>
                        
                    </div>
                </div>

                <!-- 下部：Terminal 输出台 -->
                <div class="section" id="terminal-section">
                    <h2 data-key="terminal-output-title" style="color: #b3b3b3;">Program Monitor</h2>
                    <div class="terminal-output" id="terminal-output">
                        <!-- Terminal output will be appended here -->
                    </div>
                </div>
                
            </div>            


            
        </div>
    </div>

    <!-- 固定在底部的导航栏 -->
    {% include 'footer.html' %}

    <script>

        let xPosition = 0.0;
        let yPosition = 0.0;
        let zPosition = 0.0;

        function fetchAxisValues() {
            fetch('/get-axis-values')
                .then(response => response.json())
                .then(data => {
                    console.log("Fetched Data: ", data); // Add this line to inspect the data

                    // Update the X-Axis values with two decimal places
                    document.getElementById('x-current').innerText = data["GVL_Motion_Control_single_axis.Rap_Position"].value.toFixed(2);
                    document.getElementById('x-end').innerText = data["GVL_Motion_Control_single_axis.fbsa_MoveAbs.Position"].value.toFixed(2);

                    // Update the Y-Axis values with two decimal places
                    document.getElementById('y-current').innerText = data["GVL_Motion_Control_single_axis_2.Rap_Position"].value.toFixed(2);
                    document.getElementById('y-end').innerText = data["GVL_Motion_Control_single_axis_2.fbsa_MoveAbs.Position"].value.toFixed(2);

                    // Update the Z-Axis values with two decimal places
                    document.getElementById('z-current').innerText = data["GVL_Motion_Control_single_axis_1.Rap_Position"].value.toFixed(2);
                    document.getElementById('z-end').innerText = data["GVL_Motion_Control_single_axis_1.fbsa_MoveAbs.Position"].value.toFixed(2);
                })
                .catch(error => console.error('Error fetching axis data:', error));
        }

        // Fetch values every 5 seconds
        setInterval(fetchAxisValues, 5000);




        // Function to show the edit dialog
        function showEditDialog() {
            document.getElementById('edit-dialog1').classList.remove('hidden');
        }

        // Function to close the edit dialog
        function closeEditDialog() {
            document.getElementById('edit-dialog1').classList.add('hidden');
        }

        // Function to show the edit dialog
        function showEditDialogY() {
            document.getElementById('edit-dialog2').classList.remove('hidden');
        }

        // Function to close the edit dialog
        function closeEditDialogY() {
            document.getElementById('edit-dialog2').classList.add('hidden');
        }

        // Function to show the edit dialog
        function showEditDialogZ() {
            document.getElementById('edit-dialog3').classList.remove('hidden');
        }

        // Function to close the edit dialog
        function closeEditDialogZ() {
            document.getElementById('edit-dialog3').classList.add('hidden');
        }

        // Add event listener to the edit axis button
        document.getElementById('edit-axis-x').addEventListener('click', showEditDialog);
        document.getElementById('edit-axis-y').addEventListener('click', showEditDialogY);
        document.getElementById('edit-axis-z').addEventListener('click', showEditDialogZ);
        const overrideStartButton = document.getElementById('override-stop-button');
        const overrideStopButton = document.getElementById('override-start-button');
        let isOverrideRunning = false; // Initial state

        document.getElementById('reset-axis-btn').addEventListener('click', function() {
            fetch('reset-individual_axis', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log(data.message);
            })
            .catch(error => {
                console.error('Error:', error);
            });
    });

        

        function resetAxis(axis) {
            fetch('/reset-axis', {
                method: 'POST',
                body: JSON.stringify({ axis }),
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log(data.message);
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }


        function moveAxis(axis, direction) {
            // Determine jog mode based on direction
            let jogMode = direction.includes("fast") ? "2" : "1";

            fetch('/update-axis-jog', {
                method: 'POST',
                body: JSON.stringify({ axis, direction, jogMode }),
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log(data.message);
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }






        function updateAxisValuesInGCode() {
            const updatedData = {
                "GVL_Motion_Control_single_axis.fbsa_MoveAbs.Position": {
                    "value": parseFloat(xPosition),
                    "type": "LREAL"
                },
                "GVL_Motion_Control_single_axis_2.fbsa_MoveAbs.Position": {
                    "value": parseFloat(yPosition),
                    "type": "LREAL"
                },
                "GVL_Motion_Control_single_axis_1.fbsa_MoveAbs.Position": {
                    "value": parseFloat(zPosition),
                    "type": "LREAL"
                }
            };

            // Send updated data to the server
            const xhr = new XMLHttpRequest();
            xhr.open("POST", "/update-gcode", true);
            xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
            xhr.onreadystatechange = function () {
                if (xhr.readyState === XMLHttpRequest.DONE) {
                    if (xhr.status === 200) {
                        console.log("GCode updated successfully:", updatedData);
                        
                    } else {
                        console.error("Failed to update GCode");
                    }
                }
            };
            document.getElementById('x-end').innerText = "0.00";
            document.getElementById('y-end').innerText = "0.00";
            document.getElementById('z-end').innerText = "0.00";
            console.log("Sending updated data:", updatedData);  // Log the data being sent
            xhr.send(JSON.stringify(updatedData));
        }



        // Event listener for "Start Override" button
        overrideStartButton.addEventListener('click', () => {
            if (!isOverrideRunning) {
                isOverrideRunning = true;  // Set to true
                updateOverrideState(isOverrideRunning);
            }

            overrideStartButton.classList.add('active');
            overrideStopButton.classList.remove('active');

            updateAxisValuesInGCode();
        });

        // Event listener for "Stop Override" button
        overrideStopButton.addEventListener('click', () => {
            if (isOverrideRunning) {
                isOverrideRunning = false;
                updateOverrideState(isOverrideRunning);
            }

            overrideStopButton.classList.add('active');
            overrideStartButton.classList.remove('active');
        });

        // Function to update override state
        function updateOverrideState(isOverrideRunning) {
            // Create the AJAX request
            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/update-override', true);
            xhr.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');
            
            // Prepare the data to send
            const data = JSON.stringify({ is_override_running: isOverrideRunning });
            
            // Handle the server's response
            xhr.onreadystatechange = function() {
                if (xhr.readyState === XMLHttpRequest.DONE) {
                    if (xhr.status === 200) {
                        const response = JSON.parse(xhr.responseText);
                        console.log(response.message);  // Log success message from the server
                    } else {
                        console.error('Error updating override state');
                    }
                }
            };

            // Send the AJAX request
            xhr.send(data);
        }

        function checkOverrideState() {
            // Create the AJAX request
            const xhr = new XMLHttpRequest();
            xhr.open('GET', '/get-override-state', true); // Get the override state from the server
            
            // Handle the server's response
            xhr.onreadystatechange = function() {
                if (xhr.readyState === XMLHttpRequest.DONE) {
                    if (xhr.status === 200) {
                        const response = JSON.parse(xhr.responseText);
                        isOverrideRunning = response.is_override_running; // Update the global variable

                        // Set button classes based on override state
                        if (isOverrideRunning) {
                            overrideStartButton.classList.add('active');
                            overrideStopButton.classList.remove('active');
                        } else {
                            overrideStartButton.classList.remove('active');
                            overrideStopButton.classList.add('active');
                        }
                    } else {
                        console.error('Error fetching override state');
                    }
                }
            };

            // Send the AJAX request
            xhr.send();
        }

        // Poll every 5 seconds for override state
        setInterval(checkOverrideState, 50000);

        
        const spindleStartButton = document.getElementById('spindle-start-button');
        const spindleStopButton = document.getElementById('spindle-stop-button');
        let isSpindleRunning = false; // Initial state

        // Function to update spindle state via AJAX request
        function updateSpindleState(isRunning) {
            const dataToUpdate = {
                jog_forward_3: {
                    variable: "GVL_Motion_Control_single_axis_3.bsa_Jogfwd",
                    value: isRunning,
                    type: "BOOL"
                },
                jog_backward_3: {
                    variable: "GVL_Motion_Control_single_axis_3.bsa_Jogbwd",
                    value: false, // Always false for both start and stop actions
                    type: "BOOL"
                }
            };

            fetch('/update-spindle', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(dataToUpdate)
            })
            .then(response => response.json())
            .then(data => {
                console.log(data.message); // Log the response message from the server
            })
            .catch(error => {
                console.error('Error updating spindle state:', error);
            });
        }


        document.addEventListener('DOMContentLoaded', () => {
    const spindleStartButton = document.getElementById('spindle-start-button');
    const spindleStopButton = document.getElementById('spindle-stop-button');
    const reverseCheckbox = document.getElementById('reverse-checkbox');

    // IMP THIS IS REVERSED WITH STOP
    spindleStartButton.addEventListener('click', () => {
        fetch('/stop-spindle', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({})  // Sending an empty JSON object
        })
        .then(response => response.json())
        .then(data => {
            console.log(data.message);
        })
        .catch(error => {
            console.error('Error:', error);
        });
        spindleStartButton.classList.add('active');
        spindleStopButton.classList.remove('active');
    });

    // IMP REVERSED
    spindleStopButton.addEventListener('click', () => {
        fetch('/start-spindle', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ reverse: reverseCheckbox.checked })  // Send reverse status in the body
        })
        .then(response => response.json())
        .then(data => {
            console.log(data.message);
        })
        .catch(error => {
            console.error('Error:', error);
        });

        spindleStopButton.classList.add('active');
        spindleStartButton.classList.remove('active');
    });
});



        // Function to update spindle state
        function updateSpindleState(isSpindleRunning) {
            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/update-spindle', true);
            xhr.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');
            
            const data = JSON.stringify({ is_spindle_running: isSpindleRunning });
            
            xhr.onreadystatechange = function() {
                if (xhr.readyState === XMLHttpRequest.DONE) {
                    if (xhr.status === 200) {
                        const response = JSON.parse(xhr.responseText);
                        console.log(response.message);
                    } else {
                        console.error('Error updating spindle state');
                    }
                }
            };

            xhr.send(data);
        }

        function checkSpindleState() {
            const xhr = new XMLHttpRequest();
            xhr.open('GET', '/get-spindle-state', true);
            
            xhr.onreadystatechange = function() {
                if (xhr.readyState === XMLHttpRequest.DONE) {
                    if (xhr.status === 200) {
                        const response = JSON.parse(xhr.responseText);
                        isSpindleRunning = response.is_spindle_running; // Update the global variable

                        // Set button classes based on spindle state
                        // if (isSpindleRunning) {
                        //     spindleStartButton.classList.add('active');
                        //     spindleStopButton.classList.remove('active');
                        // } else {
                        //     spindleStartButton.classList.remove('active');
                        //     spindleStopButton.classList.add('active');
                        // }
                    } else {
                        console.error('Error fetching spindle state');
                    }
                }
            };

            xhr.send();
        }


        // Poll every 5 seconds for spindle state
        setInterval(checkSpindleState, 50000);





        document.addEventListener('DOMContentLoaded', function () {
            const overrideSlider = document.getElementById('override-slider');
            const spindleSlider = document.getElementById('spindle-slider');
            const overrideValue = document.getElementById('override-value');
            const spindleValue = document.getElementById('spindle-value');

            overrideSlider.addEventListener('input', function () {
                overrideValue.textContent = overrideSlider.value;
            });

            spindleSlider.addEventListener('input', function () {
                spindleValue.textContent = spindleSlider.value;
            });

            function updateSliders() {
                const data = {
                    "GVl_Motion_Control_single_axis.LrSA_PowerOverride": {
                        "value": overrideSlider.value  // Send the correct override value
                    },
                    "GVl_Motion_Control_single_axis_3.LrSA_PowerOverride": {
                        "value": spindleSlider.value  // Send the correct spindle value
                    }
                };
                fetch('/update-sliders', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                })
                .then(response => response.json())
                .then(result => {
                    console.log(result.message);
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            }

            overrideSlider.addEventListener('change', updateSliders);
            spindleSlider.addEventListener('change', updateSliders);
        });





const sliders = document.querySelectorAll(".slider-ui");
sliders.forEach(slider => {
    let input = slider.querySelector("input[type=range]");
    let min = input.getAttribute("min");
    let max = input.getAttribute("max");
    let valueElem = slider.querySelector(".value");
    slider.querySelector(".min").innerText = min;
    slider.querySelector(".max").innerText = max;

    function setValueElem() {
        valueElem.innerText = input.value;
        let percent = (input.value - min) / (max - min) * 100;
        valueElem.style.left = percent + "%";
    }

    setValueElem();
    input.addEventListener("input", setValueElem);
    input.addEventListener("mousedown", () => {
        valueElem.classList.add("up");
    });
    input.addEventListener("mouseup", () => {
        valueElem.classList.remove("up");
    });
});


function updateSliders() {
    const xhr = new XMLHttpRequest();
    xhr.open('GET', '/get-slider-values', true);

    xhr.onreadystatechange = function() {
        if (xhr.readyState === XMLHttpRequest.DONE) {
            if (xhr.status === 200) {
                const response = JSON.parse(xhr.responseText);
                const overrideValue = response["GVl_Motion_Control_single_axis.LrSA_PowerOverride"].value;
                const spindleValue = response["GVl_Motion_Control_single_axis_3.LrSA_PowerOverride"].value;

                const overrideSlider = document.getElementById('override-slider');
                const overrideValueElem = document.getElementById('override-value');
                if (overrideSlider.value != overrideValue) {
                    overrideSlider.value = overrideValue;
                    overrideValueElem.textContent = overrideValue;
                    updateSliderPosition(overrideSlider, overrideValueElem);
                }

                const spindleSlider = document.getElementById('spindle-slider');
                const spindleValueElem = document.getElementById('spindle-value');
                if (spindleSlider.value != spindleValue) {
                    spindleSlider.value = spindleValue;
                    spindleValueElem.textContent = spindleValue;
                    updateSliderPosition(spindleSlider, spindleValueElem);
                }
            } else {
                console.error('Error fetching slider values');
            }
        }
    };

    xhr.send();
}


function updateSliderPosition(slider, valueElement) {
    const sliderMin = slider.min;
    const sliderMax = slider.max;
    const sliderValue = slider.value;
    const percentage = (sliderValue - sliderMin) / (sliderMax - sliderMin) * 100;
    valueElement.style.left = `calc(${percentage}% - 25px)`;
}

setInterval(updateSliders, 30000);




const username = "{{ username }}"; // Pass the username from Flask to JavaScript

document.addEventListener("DOMContentLoaded", function() {
    loadCategories();
});

function addCategory() {
    const categoryName = prompt("Enter new category name:");
    if (categoryName) {
        // Create new category item
        const newCategory = document.createElement("div");
        newCategory.className = "category";
        newCategory.id = `category-${categoryName.toLowerCase().replace(/\s+/g, '-')}`;
        newCategory.innerText = categoryName;
        newCategory.setAttribute("onclick", `showApps('category-${categoryName.toLowerCase().replace(/\s+/g, '-')}-apps-container')`);

        // Get the Add Category button
        const addCategoryButton = document.querySelector(".add-category");

        // Insert new category item before the Add Category button
        document.getElementById("categories").insertBefore(newCategory, addCategoryButton);

        // Create new category apps container
        const newCategoryApps = document.createElement("div");
        newCategoryApps.id = `category-${categoryName.toLowerCase().replace(/\s+/g, '-')}-apps-container`;
        newCategoryApps.className = "apps-container";

        // Append new category apps container to the body or a specific container
        document.body.appendChild(newCategoryApps);

        // Save the new category to localStorage
        saveCategory(categoryName);
    }
}

function saveCategory(categoryName) {
    let categories = JSON.parse(localStorage.getItem(`categories-${username}`)) || [];
    categories.push(categoryName);
    localStorage.setItem(`categories-${username}`, JSON.stringify(categories));
}

function loadCategories() {
    let categories = JSON.parse(localStorage.getItem(`categories-${username}`)) || [];
    categories.forEach(categoryName => {
        // Create new category item
        const newCategory = document.createElement("div");
        newCategory.className = "category";
        newCategory.id = `category-${categoryName.toLowerCase().replace(/\s+/g, '-')}`;
        newCategory.innerText = categoryName;
        newCategory.setAttribute("onclick", `showApps('category-${categoryName.toLowerCase().replace(/\s+/g, '-')}-apps-container')`);

        // Get the Add Category button
        const addCategoryButton = document.querySelector(".add-category");

        // Insert new category item before the Add Category button
        document.getElementById("categories").insertBefore(newCategory, addCategoryButton);

        // Create new category apps container
        const newCategoryApps = document.createElement("div");
        newCategoryApps.id = `category-${categoryName.toLowerCase().replace(/\s+/g, '-')}-apps-container`;
        newCategoryApps.className = "apps-container";

        // Append new category apps container to the body or a specific container
        document.body.appendChild(newCategoryApps);
    });
}

function showApps(categoryId) {
    // Hide all app icons containers
    const appContainers = document.querySelectorAll(".apps-container");
    appContainers.forEach(container => container.style.display = "none");

    // Show the selected app icons container
    const selectedContainer = document.getElementById(categoryId);
    if (selectedContainer) {
        selectedContainer.style.display = "block";
    }
}



        // 为每个类别添加点击事件监听器并更新激活状态
        document.querySelectorAll('.top-categories .category').forEach(category => {
            category.addEventListener('click', function (event) {
                // 移除其他所有类别的激活状态
                document.querySelectorAll('.top-categories .category').forEach(cat => {
                    cat.classList.remove('active');
                });

                // 添加激活状态到当前点击的类别
                category.classList.add('active');
                console.log("categorierId:", category.id)
                // 切换应用容器的显示
                var containerId = category.id + '-apps-container';
                console.log("containerId:", containerId); // 输出containerId的值
                toggleAppContainer(containerId);
                hideCustomContextMenus(); // 点击类别时隐藏菜单
                showApps(this.id + '-apps-container'); // 确保传递正确的ID格式
            });
        });

        // 为Planning类别添加点击事件监听器
        document.getElementById('category-planning').addEventListener('click', function () {
            toggleAppContainer('category-planning-apps-container');
        });

        // 为Machining类别添加点击事件监听器
        document.getElementById('category-machining').addEventListener('click', function () {
            toggleAppContainer('category-machining-apps-container');
        });

        document.getElementById('category-monitoring').addEventListener('click', function () {
            toggleAppContainer('category-monitoring-apps-container');
        });

        document.getElementById('category-community').addEventListener('click', function () {
            toggleAppContainer('category-community-apps-container');
        });

        document.getElementById('category-utility').addEventListener('click', function () {
            toggleAppContainer('category-utility-apps-container');
        });



        // 封装切换应用容器显示的函数
        // 封装切换应用容器显示的函数
        function toggleAppContainer(containerId) {
            var container = document.getElementById(containerId);

            // 隐藏所有其他应用容器
            document.querySelectorAll('.apps-container').forEach(function (cont) {
                cont.classList.remove('active');
            });

            // 切换当前容器的active类
            container.classList.toggle('active');
        }

        // 全局变量定义
        let currentCategoryId = null;

        // 获取所有应用图标和子页面空白区域
        // const appIcons = document.querySelectorAll('.app-icon');
        // const categorySubpage = document.querySelector('.apps-container');

        // 自定义右键菜单元素
        const customContextMenuApp = document.createElement('div');
        customContextMenuApp.id = 'customContextMenuApp'; // 设置元素的ID
        const customContextMenuSubpage = document.createElement('div');
        customContextMenuSubpage.id = 'customContextMenuSubpage'; // 设置元素的ID

        // 将自定义右键菜单元素添加到页面中
        document.body.appendChild(customContextMenuApp);
        document.body.appendChild(customContextMenuSubpage);

        // 为应用图标设置菜单项
        customContextMenuApp.innerHTML = `
          <button id="deleteButton">Delete</button>
          <button id="renameButton">Rename</button>
        `;

        // 为子页面空白区域设置菜单项
        customContextMenuSubpage.innerHTML = `
          <button id="addButton">Add</button>
        `;
        document.body.appendChild(customContextMenuSubpage);

        // 设置样式（可根据需要自定义）
        customContextMenuApp.classList.add('custom-context-menu');
        customContextMenuSubpage.classList.add('custom-context-menu');


        // 为整个应用容器（apps-container）添加右键点击事件监听器
        document.querySelectorAll('.apps-container').forEach(container => {
            container.addEventListener('contextmenu', function (event) {
                event.preventDefault(); // 阻止默认的上下文菜单

                // 确保点击的不是app-icon
                if (!event.target.closest('.app-icon')) {
                    customContextMenuSubpage.style.left = `${event.pageX}px`;
                    customContextMenuSubpage.style.top = `${event.pageY}px`;
                    customContextMenuSubpage.classList.add('visible');
                    // 存储当前类别ID在数据属性中
                    customContextMenuSubpage.dataset.categoryId = this.id;
                } else {
                    // 如果是app-icon，执行相应的操作
                    const currentApp = event.target.closest('.app-icon');
                    const customContextMenu = document.getElementById('customContextMenuApp');

                    if (customContextMenu) {
                        customContextMenu.style.left = `${event.pageX}px`;
                        customContextMenu.style.top = `${event.pageY}px`;
                        customContextMenu.classList.add('visible');
                    } else {
                        console.error('customContextMenuApp element not found');
                    }

                    // 给删除按钮添加点击事件监听器
                    const deleteButton = customContextMenu.querySelector('#deleteButton');
                    deleteButton.onclick = function (event) {
                        currentApp.parentNode.removeChild(currentApp);
                        customContextMenu.classList.remove('visible');
                    };

                    // 给重命名按钮添加点击事件监听器
                    const renameButton = customContextMenu.querySelector('#renameButton');
                    renameButton.onclick = function (event) {
                        const newName = prompt("Enter the new name for the app:", "");
                        if (newName !== null && newName !== "") {
                            // 假设应用名称是紧跟在图标之后的元素，这里需要根据实际情况调整
                            const appNameElement = currentApp.querySelector('.app-label');
                            if (appNameElement) {
                                appNameElement.textContent = newName;
                            }
                        }
                        customContextMenu.classList.remove('visible');
                    };
                }
            });
        });



        // Click event for the "Add" button in the custom context menu
        document.getElementById('addButton').addEventListener('click', function () {
            hideCustomContextMenus(); // 添加这行代码来隐藏菜单
            // Retrieve the stored category ID from the data attribute
            const categoryId = customContextMenuSubpage.dataset.categoryId;
            // Call the function to show the modal for adding an app
            console.log("categoryId:", categoryId)
            if (categoryId) {
                showAddListModal(categoryId);
            } else {
                const smallModal = document.getElementById('smallModal');
                smallModal.style.display = 'block';
            }
        });

        // 显示应用图标的函数，这里需要根据实际情况实现
        function showApps(appsContainerId, categoryName) {
            // Hide all app icon containers before showing the selected one
            document.querySelectorAll('.app-icons-container').forEach(container => {
                container.classList.remove('active');
            });

            // Remove the 'selected-category' class from all category items
            document.querySelectorAll('.app-category-item').forEach(item => {
                item.classList.remove('selected-category');
            });

            // Add 'active' class to the selected app icon container
            var appsContainer = document.getElementById(appsContainerId);
            if (appsContainer) {
                appsContainer.classList.add('active');
            }

            // Add 'selected-category' class to the clicked category item
            var currentCategoryItem = document.querySelector(`[onclick*='${appsContainerId}']`);
            if (currentCategoryItem) {
                currentCategoryItem.classList.add('selected-category');
            }

            // Update the category name display
            var currentCategoryNameElement = document.getElementById('current-category-name');
            if (currentCategoryNameElement) {
                currentCategoryNameElement.textContent = categoryName;
            }
        }

        function addIconToCategory(iconSrc, iconName, iconHref) {

            if (!currentCategoryId) {
                targetContainer = document.querySelector('.fixed-bottom-bar');

                // 创建新图标的元素
                const newLink = document.createElement('a');
                newLink.href = iconHref; // 设置新图标的链接地址
                newLink.className = 'app-icon';

                const newIcon = document.createElement('img');
                newIcon.src = iconSrc;
                newIcon.alt = iconName;
                newLink.appendChild(newIcon);

                const newLabel = document.createElement('div'); // 用span而不是div，保持一致性
                newLabel.textContent = iconName;
                newLink.appendChild(newLabel);

                // 将新图标添加到目标容器中
                targetContainer.appendChild(newLink);
                // handleLayoutChange();
            } else {
                const fullCategoryId = currentCategoryId.endsWith('-apps-container') ?
                    currentCategoryId :
                    currentCategoryId + '-apps-container';

                console.log("点击类别后的 currentCategoryId:", currentCategoryId);
                const categoryAppsContainer = document.getElementById(fullCategoryId);
                if (!categoryAppsContainer) {
                    console.error('Category apps container not found:', fullCategoryId);
                    return;
                }

                // 创建新图标的元素
                const newLink = document.createElement('a');
                newLink.href = iconHref; // 设置新图标的链接地址
                newLink.className = 'app-icon';

                const newIcon = document.createElement('img');
                newIcon.src = iconSrc;
                newIcon.alt = iconName;
                newLink.appendChild(newIcon);

                const newLabel = document.createElement('div');
                newLabel.className = 'app-label';
                newLabel.textContent = iconName;


                newLink.appendChild(newLabel);

                // 将新图标添加到当前类别的应用容器中
                categoryAppsContainer.appendChild(newLink);
                showModal('smallModal', false);
                // handleLayoutChange();

            }
        }

        console.log("点击类别后的 currentCategoryId:", currentCategoryId);

        // add list 里图标的点击事件
        document.querySelector('.small-modal-content').addEventListener('click', function (event) {
            const icon = event.target.closest('.app-icon');
            if (icon) {
                event.preventDefault();
                // 获取图标信息
                const iconSrc = icon.querySelector('img').src;
                const iconName = icon.querySelector('img').alt;
                const iconHref = icon.getAttribute('href');

                // 隐藏模态框
                document.getElementById('smallModal').style.display = 'none';
                hideCustomContextMenus(); // 添加图标后隐藏菜单
                // handleLayoutChange();
            }
        });


        // 为顶部的每个类别绑定点击事件，以便知道当前活跃的类别是什么
        document.querySelectorAll('.top-categories .category').forEach(category => {
            category.addEventListener('click', function (event) {
                // 设置当前类别的ID
                currentCategoryId = this.id + '-apps-container'; // 之前是 this.id + '-apps-container'
                console.log("点击类别后的 currentCategoryId:", currentCategoryId);
                hideCustomContextMenus(); // 点击类别时隐藏菜单
                showApps(this.id + '-apps-container'); // 确保传递正确的ID格式
            });
        });

        // 修改2: 统一上下文菜单的显示和隐藏逻辑
        function hideCustomContextMenus() {
            customContextMenuApp.classList.remove('visible');
            customContextMenuSubpage.classList.remove('visible');
        }


        // // 绑定模态框中的每个应用图标的点击事件
        // document.querySelectorAll('.small-modal-content .app-icon').forEach(appIconLink => {
        //       appIconLink.addEventListener('click', function(event) {
        //             event.preventDefault(); // 阻止<a>标签的默认点击行为
        //
        //             // 获取图标信息
        //             const iconSrc = this.querySelector('img').src;
        //             const iconName = this.querySelector('img').alt;
        //             const iconHref = this.getAttribute('href'); // 获取当前点击的<a>标签的链接地址
        //
        //             // 添加图标到当前类别
        //             addIconToCategory(iconSrc, iconName, iconHref);
        //
        //             // 隐藏模态框
        //             document.getElementById('smallModal').style.display = 'none';
        //             hideCustomContextMenus(); // 添加图标后隐藏菜单
        //             // handleLayoutChange();
        //       });
        // });
        //
        // // 显示smallModal模态框的函数
        // function showAddListModal(categoryId) {
        //     const smallModal = document.getElementById('smallModal');
        //     smallModal.style.display = 'block';
        //     document.getElementById('current-category-name').textContent = categoryId;
        //
        //     // 给smallModal中的每个应用添加点击事件
        //     const appIcons = smallModal.querySelectorAll('.app-icon');
        //     appIcons.forEach(appIconLink => {
        //         appIconLink.addEventListener('click', function(event) {
        //             event.preventDefault(); // 阻止<a>标签的默认点击行为
        //             const iconSrc = this.querySelector('img').src;
        //             const iconName = this.querySelector('img').alt;
        //             const iconHref = this.getAttribute('href'); // 获取当前点击的<a>标签的链接地址
        //
        //             // 将选中的应用添加到指定的类别中
        //             addIconToCategory(fullCategoryId, iconSrc, iconName, iconHref);
        //
        //             // 关闭smallModal模态框
        //             smallModal.style.display = 'none';
        //         });
        //     });
        // }

        // function addIconToBottomBar(iconSrc, iconName, iconHref) {
        //     const bottomBar = document.querySelector('.fixed-bottom-bar');
        //
        //     // 创建新图标的元素
        //     const newLink = document.createElement('a');
        //     newLink.href = iconHref; // 设置新图标的链接地址
        //     newLink.className = 'icon-button';
        //
        //     const newIcon = document.createElement('img');
        //     newIcon.src = iconSrc;
        //     newIcon.alt = iconName;
        //     newLink.appendChild(newIcon);
        //
        //     const newLabel = document.createElement('span');
        //     newLabel.textContent = iconName;
        //     newLink.appendChild(newLabel);
        //
        //     // 将新图标添加到底部菜单栏中
        //     bottomBar.appendChild(newLink);
        // }

        // // 为底部菜单栏添加右键点击事件监听
        // document.querySelector('.fixed-bottom-bar').addEventListener('contextmenu', function(event) {
        //     event.preventDefault(); // 阻止默认的上下文菜单
        //
        //     const target = event.target;
        //
        //     // 判断点击的是否为图标按钮
        //     if (target.classList.contains('icon-button') || target.closest('.icon-button')) {
        //         const clickedIcon = target.closest('.icon-button');
        //         // 显示自定义菜单并调整位置到鼠标点击处
        //         customContextMenuApp.style.left = `${event.pageX}px`;
        //         customContextMenuApp.style.top = `${event.pageY}px`;
        //         customContextMenuApp.classList.add('visible');
        //
        //         // 给删除按钮添加事件监听器
        //         document.getElementById('deleteButton').onclick = function() {
        //             clickedIcon.remove(); // 删除点击的图标
        //             customContextMenuApp.classList.remove('visible'); // 隐藏菜单
        //         };
        //
        //         // 给重命名按钮添加事件监听器
        //         document.getElementById('renameButton').onclick = function() {
        //             const newName = prompt('Enter the new name:');
        //             if (newName) {
        //                 clickedIcon.querySelector('img').alt = newName; // 假设你想修改图片的 alt 属性为新名称
        //                 // 这里可能还需要更新显示名称的部分，这取决于你的HTML结构
        //             }
        //             customContextMenuApp.classList.remove('visible'); // 隐藏菜单
        //             // handleLayoutChange();
        //         };
        //
        //     } else {
        //         // 如果点击的是空白区域，则显示添加菜单
        //         customContextMenuSubpage.style.left = `${event.pageX}px`;
        //         customContextMenuSubpage.style.top = `${event.pageY}px`;
        //         customContextMenuSubpage.classList.add('visible');
        //
        //         // 给添加按钮添加事件监听器
        //         document.getElementById('addButton').onclick = function() {
        //             // 实现添加图标的逻辑
        //             // 这可能包括弹出一个模态框让用户选择或输入新应用的信息
        //             customContextMenuSubpage.classList.remove('visible'); // 隐藏菜单
        //             // handleLayoutChange();
        //         };
        //     }
        // });


        // 全局点击事件，用于隐藏自定义菜单
        document.addEventListener('click', function (event) {
            if (!event.target.closest('.custom-context-menu')) {
                customContextMenuApp.classList.remove('visible');
                customContextMenuSubpage.classList.remove('visible');
            }
        });


        function addNewCategory() {
            var newCategoryDiv = document.createElement('div');
            newCategoryDiv.className = 'category';
            newCategoryDiv.textContent = 'New Category';
            var uniqueId = 'category-' + Date.now(); // 确保ID是唯一的
            console.log("uniqueId", uniqueId)
            newCategoryDiv.id = uniqueId;

            document.querySelector('.top-categories').appendChild(newCategoryDiv);

            // 创建新类别的应用容器
            var newAppsContainer = document.createElement('div');
            newAppsContainer.id = uniqueId + '-apps-container';
            newAppsContainer.className = 'apps-container';
            document.body.appendChild(newAppsContainer); // 你可能需要将这个容器放在页面的适当位置
        }

        function addNewApp() {
            // 获取当前选中的category
            var activeCategory = document.querySelector('.top-categories .category.active');
            console.log('activeCategory:', activeCategory);
            if (activeCategory) {
                // 显示modal窗口
                var smallModal = document.getElementById('smallModal');
                smallModal.style.display = 'block';

                // 设置当前的category名称到modal窗口，以便知道我们将应用添加到哪个category
                var currentCategoryName = document.getElementById('current-category-name');
                console.log('currentCategoryName:', currentCategoryName)
                currentCategoryName.textContent = activeCategory.textContent;

                // 存储当前选中的category的id，供后续使用
                console.log('activeCategory:', activeCategory.id);
                smallModal.dataset.activeCategory = activeCategory.id;

            } else {
                alert('Please select a category first.');
            }
        }

        // 绑定到父元素上的事件委托，以处理所有当前和未来的 .category 的点击事件
        document.querySelector('.top-categories').addEventListener('click', function (event) {
            // 从点击的元素向上查找最近的 .category 元素
            var category = event.target.closest('.category');
            if (category) {
                // 移除其他所有类别的激活状态
                document.querySelectorAll('.top-categories .category').forEach(cat => {
                    cat.classList.remove('active');
                });

                // 为当前点击的类别添加激活状态
                category.classList.add('active');

                // ...（这里可以加入其他逻辑，比如显示对应的应用容器）...
            }
        });


        // 绑定模态框中的每个应用图标的点击事件
        document.querySelectorAll('.small-modal-content .app-icon').forEach(appIconLink => {
            appIconLink.addEventListener('click', function (event) {
                event.preventDefault(); // 阻止<a>标签的默认点击行为

                // 获取图标信息和链接地址
                const iconImg = this.querySelector('img');
                const iconSrc = iconImg ? iconImg.src : '';
                const iconName = iconImg ? iconImg.alt : '';
                const iconHref = this.getAttribute('href'); // 确保这个是正确的链接地址

                // 从模态框中获取当前活跃类别的ID
                const smallModal = document.getElementById('smallModal');
                const activeCategoryId = smallModal.dataset.activeCategory;
                const activeCategoryContainerId = activeCategoryId + '-apps-container';

                // 添加图标和链接到当前类别
                addAppToCategory(activeCategoryContainerId, iconSrc, iconName, iconHref);

                // 隐藏模态框
                smallModal.style.display = 'none';

                // hideCustomContextMenus(); // 如果需要隐藏自定义上下文菜单，请取消注释
                // handleLayoutChange(); // 如果需要处理布局变化，请取消注释
            });
        });

        function addAppToCategory(containerId, iconSrc, iconName, iconHref) {
            // 获取类别的容器元素
            var categoryContainer = document.getElementById(containerId);
            if (categoryContainer) {
                // 创建一个新的<a>元素，用于包含应用图标和名称
                var newAppLink = document.createElement('a');
                newAppLink.className = 'app-icon';
                newAppLink.href = iconHref; // 设置链接地址
                newAppLink.innerHTML = `<img src="${iconSrc}" alt="${iconName}"><div>${iconName}</div>`;

                // 添加到类别容器中
                categoryContainer.appendChild(newAppLink);

                // 确保类别容器是可见的
                categoryContainer.style.display = 'flex'; // 或者其他适合你布局的display值
            } else {
                console.error('No category container found with ID:', containerId);
            }
        }


        // 监听右键点击事件以显示自定义上下文菜单
        // document.addEventListener('contextmenu', function(event) {
        //   event.preventDefault();
        //   const clickedElement = event.target.closest('.app-icon');
        //   if (clickedElement) {
        //     // 显示自定义上下文菜单
        //     const customContextMenu = document.getElementById('customContextMenu');
        //     customContextMenu.style.left = `${event.pageX}px`;
        //     customContextMenu.style.top = `${event.pageY}px`;
        //     customContextMenu.style.display = 'block';
        //
        //     // 为delete按钮添加事件监听器
        //     document.getElementById('deleteApp').onclick = function() {
        //       // 删除对应的图标元素
        //       clickedElement.remove();
        //       // 隐藏自定义上下文菜单
        //       customContextMenu.style.display = 'none';
        //     };
        //
        //     // 为rename按钮添加事件监听器
        //     document.getElementById('renameApp').onclick = function() {
        //       // 请求新的应用名称
        //       const newName = prompt('Enter the new name for the app:');
        //       if (newName) {
        //         // 找到图标名称元素并更新它的文本
        //         const nameElement = clickedElement.querySelector('div');
        //         if (nameElement) {
        //           nameElement.textContent = newName;
        //         }
        //       }
        //       // 隐藏自定义上下文菜单
        //       customContextMenu.style.display = 'none';
        //     };
        //   }
        // });
        // 状态框
        // 当前选择的轴
        let selectedAxis = null;

// Function to handle axis selection
function selectAxis(axis) {
    selectedAxis = axis;
    document.getElementById('axis-controls').style.display = 'block';
    document.querySelectorAll('.axis').forEach(el => el.classList.remove('selected'));
    document.getElementById(`status-${axis}-axis`).classList.add('selected');
}

// Update speed
// document.getElementById('set-speed').addEventListener('click', function() {
//     const speed = document.getElementById('speed').value;
//     if (selectedAxis) {
//         document.getElementById(`${selectedAxis}-current`).textContent = parseFloat(speed).toFixed(3);

//         const xhr = new XMLHttpRequest();
//         xhr.open('POST', '/update-axis-speed', true);
//         xhr.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');
//         xhr.onreadystatechange = function() {
//             if (xhr.readyState === XMLHttpRequest.DONE) {
//                 if (xhr.status === 200) {
//                     console.log('Speed updated successfully');
//                 } else {
//                     console.error('Failed to update speed');
//                 }
//             }
//         };
//         xhr.send(JSON.stringify({ axis: selectedAxis, current_position: parseFloat(speed).toFixed(3) }));
//     }
// });

// Function to handle speed update for a specific axis
function updateAxisSpeed(axis) {
    const speedInput = document.getElementById(`speed-${axis}`); // Input ID pattern: speed-x, speed-y, speed-z
    const speed = speedInput.value;

    // Update the displayed current speed for the selected axis
    document.getElementById(`${axis}-current`).textContent = parseFloat(speed).toFixed(3);

    // Send the update to the server
    const xhr = new XMLHttpRequest();
    xhr.open('POST', '/update-axis-speed', true);
    xhr.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');
    xhr.onreadystatechange = function () {
        if (xhr.readyState === XMLHttpRequest.DONE) {
            if (xhr.status === 200) {
                console.log(`Speed updated successfully for ${axis} axis`);
            } else {
                console.error(`Failed to update speed for ${axis} axis`);
            }
        }
    };
    xhr.send(JSON.stringify({ axis: axis, current_position: parseFloat(speed).toFixed(3) }));
}

// Separate functions for each axis
function setSpeedX() {
    updateAxisSpeed('x');
}

function setSpeedY() {
    updateAxisSpeed('y');
}

function setSpeedZ() {
    updateAxisSpeed('z');
}



// Update position
// document.getElementById('set-position').addEventListener('click', function() {
//     const position = document.getElementById('position').value;
//     if (selectedAxis) {
//         document.getElementById(`${selectedAxis}-end`).textContent = parseFloat(position).toFixed(3);
//         const xhr = new XMLHttpRequest();
//         xhr.open('POST', '/update-axis-position', true);
//         xhr.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');
//         xhr.onreadystatechange = function() {
//             if (xhr.readyState === XMLHttpRequest.DONE) {
//                 if (xhr.status === 200) {
//                     console.log('Position updated successfully');
//                 } else {
//                     console.error('Failed to update position');
//                 }
//             }
//         };
//         xhr.send(JSON.stringify({ axis: selectedAxis, end_position: parseFloat(position).toFixed(3) }));
//     }
// });

function updateAxisPosition(axis, inputId) {
    const positionInput = document.getElementById(inputId);
    if (!positionInput) {
        console.error(`Input field for ${axis} axis not found`);
        return;
    }

    const position = parseFloat(positionInput.value).toFixed(3);
    if (isNaN(position)) {
        console.error(`Invalid position entered for ${axis} axis`);
        return;
    }

    // Store the new position in the corresponding global variable
    if (axis === 'x') xPosition = position;
    if (axis === 'y') yPosition = position;
    if (axis === 'z') zPosition = position;

    console.log(`Updated ${axis.toUpperCase()} Position: ${position}`);

    // Update the displayed end position for the selected axis
    const endPositionElement = document.getElementById(`${axis}-end`);
    if (endPositionElement) {
        endPositionElement.textContent = position;
    } else {
        console.error(`Display element for ${axis} axis end position not found`);
        return;
    }
}

// Separate functions for each axis
function setPositionX() {
    updateAxisPosition('x', 'position-x');
}

function setPositionY() {
    updateAxisPosition('y', 'position-y');
}

function setPositionZ() {
    updateAxisPosition('z', 'position-z');
}


// function updateAxisStatus() {
//     // Perform an AJAX request to get the current axis status
//     fetch('/get_axis_status')
//         .then(response => response.json())
//         .then(data => {
//             // Update the DOM elements with the fetched data
//             for (const axis in data) {
//                 document.getElementById(`${axis}-current`).textContent = parseFloat(data[axis].current).toFixed(3);
//                 document.getElementById(`${axis}-end`).textContent = parseFloat(data[axis].end).toFixed(3);
//                 // document.getElementById(`${axis}-active`).textContent = parseFloat(data[axis].active).toFixed(3);
//             }
//         })
//         .catch(error => console.error('Error fetching axis status:', error));
// }

// // Poll every 5 seconds (5000 milliseconds)
// setInterval(updateAxisStatus, 5000);

        // Toggle the axis power
        function toggleAxis(axis) {
            // Only toggle for X-axis; similar logic can be applied for other axes if needed
            if (axis === 'x') {
                const button = document.getElementById('enable-axis-x');
                const isEnabling = button.textContent.includes("Enable");

                // Set the desired JSON values based on whether we are enabling or stopping the axis
                const jsonValues = {
                    "GVl_Motion_Control_single_axis.bsa_PowerEn": { "value": isEnabling, "type": "BOOL" },
                    "GVl_Motion_Control_single_axis.bsa_PowerEnPostive": { "value": isEnabling, "type": "BOOL" },
                    "GVl_Motion_Control_single_axis.bsa_PowerEnNegative": { "value": isEnabling, "type": "BOOL" },
                    "GVL_Motion_Control_single_axis.fbsa_ReadActualPosition.Enable": { "value": isEnabling, "type": "BOOL" },
                    "GVL_Motion_Control_single_axis.fbsa_MoveAbs.Execute": { "value": isEnabling, "type": "BOOL" }
                };

                // Update the button text
                button.textContent = isEnabling ? "Disable" : "Enable";

                // Send JSON values to the server
                updateAxisState(jsonValues);
            }
            else if (axis === 'y') {
                const button = document.getElementById('enable-axis-y');
                const isEnabling = button.textContent.includes("Enable");

                // Set the desired JSON values based on whether we are enabling or stopping the axis
                const jsonValues = {
                    "GVl_Motion_Control_single_axis_2.bsa_PowerEn": { "value": isEnabling, "type": "BOOL" },
                    "GVl_Motion_Control_single_axis_2.bsa_PowerEnPostive": { "value": isEnabling, "type": "BOOL" },
                    "GVl_Motion_Control_single_axis_2.bsa_PowerEnNegative": { "value": isEnabling, "type": "BOOL" },
                    "GVL_Motion_Control_single_axis_2.fbsa_ReadActualPosition.Enable": { "value": isEnabling, "type": "BOOL" },
                    "GVL_Motion_Control_single_axis_2.fbsa_MoveAbs.Execute": { "value": isEnabling, "type": "BOOL" }
                };

                // Update the button text
                button.textContent = isEnabling ? "Disable" : "Enable";

                // Send JSON values to the server
                updateAxisState(jsonValues);
            }
            else if (axis === 'z') {
                const button = document.getElementById('enable-axis-z');
                const isEnabling = button.textContent.includes("Enable");

                // Set the desired JSON values based on whether we are enabling or stopping the axis
                const jsonValues = {
                    "GVl_Motion_Control_single_axis_1.bsa_PowerEn": { "value": isEnabling, "type": "BOOL" },
                    "GVl_Motion_Control_single_axis_1.bsa_PowerEnPostive": { "value": isEnabling, "type": "BOOL" },
                    "GVl_Motion_Control_single_axis_1.bsa_PowerEnNegative": { "value": isEnabling, "type": "BOOL" },
                    "GVL_Motion_Control_single_axis_1.fbsa_ReadActualPosition.Enable": { "value": isEnabling, "type": "BOOL" },
                    "GVL_Motion_Control_single_axis_1.fbsa_MoveAbs.Execute": { "value": isEnabling, "type": "BOOL" }
                };

                // Update the button text
                button.textContent = isEnabling ? "Stop" : "Enable";
 
                // Send JSON values to the server
                updateAxisState(jsonValues);
            }
        }

        // Function to send updated JSON values to the backend
        function updateAxisState(values) {
            fetch('/update-axis-state', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(values)
            })
            .then(response => response.json())
            .then(data => {
                console.log('Axis state updated:', data);
            })
            .catch((error) => {
                console.error('Error updating axis state:', error);
            });
        }



        // JavaScript for terminal output
        function logMessage(message) {
            const terminalOutput = document.getElementById('terminal-output');
            const newMessage = document.createElement('div');
            newMessage.textContent = message;
            terminalOutput.appendChild(newMessage);
            terminalOutput.scrollTop = terminalOutput.scrollHeight; // Scroll to bottom
        }

        // JavaScript for connection and axis functions
        document.addEventListener('DOMContentLoaded', function () {
        // Check if the open-port button exists
        const openPortBtn = document.getElementById('open-port-btn');
        if (openPortBtn) {
            openPortBtn.addEventListener('click', function () {
                const amsNetID = document.getElementById('amsnetid').value;
                const port = document.getElementById('port').value;
                logMessage(`Opening port with AmsNetID: ${amsNetID} and Port: ${port}`);
            });
        }

        











    // Set-speed button
    const setSpeedBtn = document.getElementById('set-speed');
    if (setSpeedBtn) {
        setSpeedBtn.addEventListener('click', function () {
            if (selectedAxis) {
                const speed = document.getElementById('speed').value;
                logMessage(`Setting ${selectedAxis.toUpperCase()} Axis speed to ${speed}`);
            } else {
                logMessage('No axis selected');
            }
        });
    }

    // Set-position button
    const setPositionBtn = document.getElementById('set-position');
    if (setPositionBtn) {
        setPositionBtn.addEventListener('click', function () {
            if (selectedAxis) {
                const position = document.getElementById('position').value;
                logMessage(`Setting ${selectedAxis.toUpperCase()} Axis position to ${position}`);
            } else {
                logMessage('No axis selected');
            }
        });
    }

    // Override slider
    const overrideSlider = document.getElementById('override-slider');
    if (overrideSlider) {
        overrideSlider.addEventListener('input', function () {
            document.getElementById('override-value').textContent = this.value;
        });
    }

    // Spindle slider
    const spindleSlider = document.getElementById('spindle-slider');
    if (spindleSlider) {
        spindleSlider.addEventListener('input', function () {
            document.getElementById('spindle-value').textContent = this.value;
        });
    }
});




        //============================================================
        // 获取模态框元素
        var customerServiceModal = document.getElementById("customer-service-modal");
        var aiChatModal = document.getElementById("AI-chat-modal");
        var helpServiceModal = document.getElementById("help-service-modal")
        var settingModal = document.getElementById("setting-modal")
        var monitoringModal = document.getElementById("monitoring-modal")
        var searchModal = document.getElementById("search-modal")

        // 获取打开模态框的按钮元素
        var customerServiceBtn = document.getElementById("customer-service-button");
        var aiChatBtn = document.getElementById("AI-chat-button");
        var helpServiceBtn = document.getElementById("help-service-button")
        var settingBtn = document.getElementById("setting-button")
        var monitoringBtn = document.getElementById("monitoring-button")
        var searchBtn = document.getElementById("search-button")

        // 获取模态框内的所有关闭按钮元素
        var closeButtons = document.getElementsByClassName("close-button");

        // 点击按钮时打开对应的模态框
        customerServiceBtn.onclick = function () {
            customerServiceModal.style.display = "block";
        }

        aiChatBtn.onclick = function () {
            aiChatModal.style.display = "block";
        }

        settingBtn.onclick = function () {
            settingModal.style.display = "block";
        }

        monitoringBtn.onclick = function () {
            monitoringModal.style.display = "block";
        }

        helpServiceBtn.onclick = function () {
            helpServiceModal.style.display = "block";
        }

        searchBtn.onclick = function () {
            searchModal.style.display = "block";
        }

        // 为每个关闭按钮添加点击事件监听器
        for (var i = 0; i < closeButtons.length; i++) {
            closeButtons[i].onclick = function () {
                // 这里我们可以关闭这个按钮所在的模态框
                this.closest('.modal').style.display = 'none';
            }
        }

        // 点击模态框外任何地方关闭模态框
        window.onclick = function (event) {
            if (event.target == customerServiceModal) {
                customerServiceModal.style.display = "none";
            }
            if (event.target == aiChatModal) {
                aiChatModal.style.display = "none";
            }
            if (event.target == helpServiceModal) {
                helpServiceModal.style.display = "none";
            }
            if (event.target == settingModal) {
                settingModal.style.display = "none";
            }
            if (event.target == monitoringModal) {
                monitoringModal.style.display = "none";
            }
            if (event.target == searchModal) {
                searchModal.style.display = "none";
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            const aiChatModal = document.getElementById("AI-chat-modal");
            const closeButtons = document.getElementsByClassName("close-button");
            const aiChatBtn = document.getElementById("AI-chat-button");
            const sendButton = document.getElementById("send-message");
            const chatInput = document.getElementById("chat-input");
            const chatHistory = document.getElementById("chat-history");

            // 点击按钮打开 AI chat 模态框
            aiChatBtn.addEventListener('click', function () {
                aiChatModal.style.display = "block";
            });

            // 为每个关闭按钮添加点击事件监听器
            for (let i = 0; i < closeButtons.length; i++) {
                closeButtons[i].addEventListener('click', function () {
                    aiChatModal.style.display = "none";
                });
            }

            // 点击模态框外任何地方关闭模态框
            window.addEventListener('click', function (event) {
                if (event.target == aiChatModal) {
                    aiChatModal.style.display = "none";
                }
            });

            // 发送消息
            sendButton.addEventListener('click', function () {
                const question = chatInput.value;
                if (question.trim() !== '') {
                    // 将用户消息添加到聊天记录中
                    chatHistory.innerHTML += '<div><strong>You:</strong> ' + question + '</div>';
                    // 发送 AJAX 请求到后端
                    $.ajax({
                        type: 'POST',
                        contentType: 'application/json',
                        url: '/ask',
                        data: JSON.stringify({ 'question': question }),
                        success: function (data) {
                            // 将 ChatGPT 的回复添加到聊天记录中
                            chatHistory.innerHTML += '<div><strong>ChatGPT:</strong> ' + data.answer + '</div>'; // 确保这里使用 'data.answer'
                            // 清空输入框
                            chatInput.value = '';
                        },
                        error: function (xhr, status, error) {
                            console.error('An error occurred:', error);
                            // 将错误消息添加到聊天记录中
                            chatHistory.innerHTML += '<div><strong>Error:</strong> An error occurred while processing your request.</div>';
                        }
                    });
                }
            });
        });

        // 搜索
        document.addEventListener('DOMContentLoaded', function () {
            const searchInput = document.getElementById('search-input');
            const searchResults = document.getElementById('search-results');

            document.getElementById('search-form').addEventListener('submit', function (event) {
                event.preventDefault();
                const query = searchInput.value.trim();

                if (query) {
                    fetch(`/search?query=${query}`)
                        .then(response => response.json())
                        .then(data => {
                            displaySearchResults(data);
                        });
                }
            });

            function displaySearchResults(results) {
                searchResults.innerHTML = '';
                if (results.length === 0) {
                    searchResults.innerHTML = '<p>No results found</p>';
                } else {
                    results.forEach(result => {
                        const resultItem = document.createElement('div');
                        resultItem.classList.add('search-result-item');
                        resultItem.innerHTML = `
                    <img src="${result.icon}" alt="${result.name}">
                    <span>${result.name}</span>
                `;
                        resultItem.addEventListener('click', function () {
                            window.location.href = result.url;
                        });
                        searchResults.appendChild(resultItem);
                    });
                }
            }
        });




    </script>
</body>

</html>
