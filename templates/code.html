<!DOCTYPE html>
<html>

<head>
    <title>Kompaki</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        .highlighted-line {
            background-color: #45a049;
        }

        .fixed-bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #fff;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.2);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
        }

        .icon-button.active-icon::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 15px;
            background-color: #4CAF50;
        }

        .icon-button {
            border: none;
            background-color: transparent;
            cursor: pointer;
            outline: none;
        }

        .icon-button img {
            width: 80px;
            height: auto;
        }

        /* 模态框的基本样式 */
        .modal {
            display: none;
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            z-index: 1000;
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 60px;
            border: 1px solid #888;
            width: 80%;
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 46px;
            font-weight: bold;
        }

        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        #search-input {
            width: 80%;
            padding: 10px;
            font-size: 32px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        #search-form button {
            padding: 10px 20px;
            font-size: 32px;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
        }

        #search-modal .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 60px;
            border: 1px solid #888;
            width: 80%;
        }

        #search-form button:hover {
            background-color: #45a049;
        }

        .chat-history {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            margin-bottom: 10px;
            font-size: 30px;
            padding: 10px;
        }

        #chat-input {
            width: calc(100% - 90px);
            padding: 10px;
            margin-right: 10px;
            font-size: 30px;
            box-sizing: border-box;
        }

        #send-message {
            width: 100px;
            padding: 20px;
            font-size: 30px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }

        #send-message:hover {
            background-color: #45a049;
        }

        .faq-question {
            background-color: #eee;
            color: #444;
            cursor: pointer;
            padding: 32px;
            width: 100%;
            text-align: left;
            border: none;
            outline: none;
            transition: 0.4s;
            font-size: 32px;
        }

        .faq-answer {
            padding: 0 32px;
            font-size: 32px;
            background-color: white;
            display: none;
            overflow: hidden;
        }

        .setting-option-button {
            background: none;
            border: none;
            cursor: pointer;
        }

        .setting-option-button img {
            width: 50px;
            height: auto;
        }

        .modal-content p {
            text-align: center;
            margin-top: 5px;
        }

        #customer-service-modal .welcome-message {
            font-size: 30px;
            margin-top: 20px;
        }

        #customer-service-modal form {
            margin-top: 40px;
        }

        #customer-service-modal input,
        #customer-service-modal textarea {
            width: 100%;
            padding: 8px;
            margin: 20px 0;
            box-sizing: border-box;
            font-size: 30px;
        }

        #customer-service-modal button {
            font-size: 40px;
        }

        .container {
            display: flex;
            position: fixed;
            /* top: 200px; */
            width: 100%;
            height: 100%;
        }

        .code-display {
            width: 79%;
            background-color: #424242;
            padding: 10px;
            box-sizing: border-box;
            overflow-y: auto;
        }

        .code-list {
            width: 20%;
            background-color: #5f6368;
            padding: 10px;
            box-sizing: border-box;
            overflow-y: auto;
        }

        .code-item {
            background-color: #3c3c3c;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: background-color 0.5s, box-shadow 0.5s;
            font-size: 16px;
            font-weight: 500;
            font-family: 'Roboto', sans-serif; /* Roboto font applied */
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #b3b3b3;
        }

        .code-item.selected {
            background-color: #4CAF50;
            color: #fff;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .options-button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 24px;
            padding: 5px;
            margin-left: 10px;
            color: #fff;
            font-weight: bold;
        }

        .dropdown-menu {
            position: absolute;
            right: 0;
            top: 100%;
            background-color: #333;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            min-width: 30%;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            padding: 0;
        }

        .rename-button,
        .delete-button {
            background-color: #333;
            border: none;
            padding: 10px;
            width: 100%;
            text-align: left;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            box-sizing: border-box;
            color: #b3b3b3;
        }

        .rename-button:hover {
            background-color: #f5f5f5;
            color: #333;
        }

        .delete-button {
            color: red;
        }

        .delete-button:hover {
            background-color: #f5f5f5;
        }


        #code-editor {
            width: 100%;
            height: 300px;
            padding: 10px;
            font-size: 16px;
            font-family: monospace;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            resize: vertical;
            background-color: #f5f5f5;
            transition: border-color 0.3s;
        }

        #code-editor:focus {
            border-color: #4CAF50;
        }

        /* #save-code,
        #view-3d-button,
        #download-gcode {
            margin-top: 10px;
        } */


        #current-code-name {
            font-weight: bold;
            margin-bottom: 10px;
        }

        button {
            padding: 10px ;
            font-size: 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            outline: none;
        }




        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        #upload-button {
            width: 100%;
            background-color: #388e3c;
            color: white;
            padding: 16px 0px;
            font-size: 1.1rem;
            border: none;
            outline: none;
            border-radius: 8px;
            font-weight: 599;
            cursor: pointer;
            margin: 10px 0 10px;
            transition: 0.5s ease;
        }

        #upload-button:hover {
            background-color: #2e7d32;
            outline: 2px solid white;
            transform: scale(0.95);
        }


        #save-code,
        #view-3d-button,
        #clear-code-button,
        #download-gcode {
            width: 100%;
            background-color: #4CAF50;
            color: white;
            padding: 16px 0px;
            font-size: 1.1rem;
            border: none;
            outline: none;
            border-radius: 6px;
            font-weight: 599;
            cursor: pointer;
            margin: 7px 0 10px;
            transition: 0.5s ease;
            flex: 1;                    /* Ensures all buttons take equal space */
        }

        #save-code:hover,
        #view-3d-button:hover,
        #clear-code-button:hover,
        #download-gcode:hover {
            background-color: #388e3c;
            outline: 2px solid white;
            transform: scale(0.95);
        }

        /* 可视化模块的基本样式 */
        .visualization-modal {
            display: none;
            /* 默认隐藏 */
            position: fixed;
            /* 固定在页面上 */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            /* 背景色半透明 */
            z-index: 1000;
            /* 保证模态框在前面 */
        }

        /* 模态内容的样式 */
        .visualization-modal-content {

            background-color: #fefefe;
            margin: 2% auto;
            /* 15% 从顶部开始，居中 */
            padding: 60px;
            border: 1px solid #888;
            width: 60%;
            height: 80%;
            /* 可以根据需求调整宽度 */
            overflow: hidden;
            /* 隐藏超出部分 */
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            /* 添加此行以确保关闭按钮相对于模态内容进行定位 */
        }

        /* 关闭按钮样式 */
        .visualization-close-button {
            color: #aaa;
            position: absolute;
            /* 绝对定位 */
            top: 10px;
            /* 调整位置 */
            right: 20px;
            /* 调整位置 */
            font-size: 46px;
            font-weight: bold;
            z-index: 1001;
            /* 确保z-index值高于模态框内容 */
            cursor: pointer;
        }
            /* Container to align buttons in one line */
        .button-container {
            display: flex;                /* Flexbox layout */
            justify-content: space-between; /* Space between the buttons */
            gap: 10px;                    /* Optional spacing between buttons */
        }
    </style>
    <!-- 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="static/js/OrbitControls.js"></script> -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <script src="https://cdn.jsdelivr.net/gh/kerdirks/JSCut/gcodeviewer/gcodeviewer.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/theme/dracula.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/gcode/gcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>




</head>

<body>
    <!-- Top navigation bar -->
    {% include 'insidenavBar.html' %}

    <div class="container">
        <div id="code-list" class="code-list">
            <!-- 已上传的代码文件名将会被添加到这里 -->

        <!-- code storage-->
        <form id="upload-form" style="display: none;">
            <input type="file" name="codeFile" id="codeFile">
        </form>
        <button id="upload-button">
            Upload Code
            <img src="{{ url_for('static', filename='upload.png') }}" alt="Upload Icon" style="width: 16px; margin-left: 8px; position: relative; bottom: -1px;">
        </button>
        
        

        </div>

        <div id="code-display" class="code-display">
            <div id="current-code-name"></div>
            <textarea id="code-editor" name="codeEditor" spellcheck="false"></textarea>
            
            <!-- Wrap the buttons in a container for alignment -->
            <div class="button-container">
                <button id="save-code">Save
                    <img src="{{ url_for('static', filename='save.png') }}" alt="Upload Icon" style="width: 14px; margin-left: 8px; position: relative; bottom: -0.5px;">
                </button>
                <button id="view-3d-button">View 3D</button>
                <button id="clear-code-button">Clear Code</button>
                <button id="download-gcode">Download
                    <img src="{{ url_for('static', filename='downloads.png') }}" alt="Upload Icon" style="width: 14px; margin-left: 8px; position: relative; bottom: -0.5px;">
                </button>
            </div>
        </div>
 
        


        <!-- 可视化模块模态框 -->
        <div id="visualization-modal" class="visualization-modal">
            <div class="visualization-modal-content">
                <span class="visualization-close-button" id="close-visualization-modal">&times;</span>
                <div id="visualization-container">
                    <!-- 这里将放置可视化内容 -->
                </div>
            </div>
        </div>


    </div>





    <!-- 固定在底部的导航栏 -->
    {% include 'footer.html' %}

    <script>

        var codeEditor;
        let viewer;  // 提升 viewer 的作用域，使其在全局范围内可访问

        // 手动绑定 OrbitControls 到 THREE 对象
        // THREE.OrbitControls = OrbitControls;

        // console.log(typeof OrbitControls);

        document.addEventListener('DOMContentLoaded', function () {
            // 初始化 CodeMirror 或 Ace Editor
            codeEditor = CodeMirror.fromTextArea(document.getElementById('code-editor'), {
                lineNumbers: true,
                mode: 'gcode',
                theme: 'dracula'
            });

            codeEditor.setSize('100%', '500px');  // 设置编辑器的大小

            // Function to fetch and highlight line
            function fetchAndHighlightLine() {
                const xhr = new XMLHttpRequest();
                xhr.open('GET', '/get-highlight-line', true);
                xhr.onreadystatechange = function() {
                    if (xhr.readyState === XMLHttpRequest.DONE) {
                        if (xhr.status === 200) {
                            const response = JSON.parse(xhr.responseText);
                            const highlightLineNumber = parseInt(response.highlight_line, 10);
                            highlightLine(highlightLineNumber);
                        } else {
                            console.error('Error fetching highlight line');
                        }
                    }
                };
                xhr.send();
            }

            // Fetch highlight line number on page load
            fetchAndHighlightLine();

            // Set interval to fetch highlight line number periodically (e.g., every 5 seconds)
            setInterval(fetchAndHighlightLine, 1000);

            // 其他页面加载逻辑
        });

        function highlightLine(lineNumber) {
            var doc = codeEditor.getDoc();
            // Clear previous highlights
            doc.eachLine(function(lineHandle) {
                codeEditor.removeLineClass(lineHandle, 'background', 'highlighted-line');
            });
            // Highlight the new line
            var lineInfo = doc.getLineHandle(lineNumber - 1); // Line numbers are 0-based
            codeEditor.addLineClass(lineInfo, 'background', 'highlighted-line');
        }

        // 函数来处理代码显示和编辑
        function displayCode(codeName) {
            fetch(`/get-code?name=${encodeURIComponent(codeName)}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.code_content) {
                        // 将代码内容加载到 CodeMirror 或 Ace Editor 中
                        codeEditor.setValue(data.code_content);  // 对于 CodeMirror 和 Ace Editor 都适用
                        // codeEditor.clearSelection();  // 清除选中的部分，防止用户误编辑
                        // 显示保存按钮和3D查看按钮
                        document.getElementById('save-code').style.display = 'block';
                        document.getElementById('view-3d-button').style.display = 'block';

                        var codeListItems = document.querySelectorAll('#code-list li');
                        codeListItems.forEach(function (item) {
                            item.classList.remove('selected');  // 移除其他项的选中状态
                            if (item.textContent.trim() === codeName) {
                                item.classList.add('selected');  // 为匹配的项添加选中状态
                            }
                        });

                        fetchAndHighlightLine();



                    } else {
                        throw new Error('Code content not found');
                    }
                })
                .catch(error => {
                    console.error('Error fetching code:', error);
                });
        }



        // 函数来添加新的列表项并绑定点击事件
        function addListItem(codeName) {
            var codeList = document.getElementById('code-list');
            var listItem = document.createElement('div');
            listItem.className = 'code-item';

            // 添加文件名的文本部分
            var textSpan = document.createElement('span');
            textSpan.textContent = codeName;
            listItem.appendChild(textSpan);

            // 添加三个点的按钮
            var optionsButton = document.createElement('button');
            optionsButton.className = 'options-button';
            optionsButton.innerHTML = '&#x22EE;';  // 使用Unicode字符表示三个点
            listItem.appendChild(optionsButton);

            // 创建下拉菜单
            var dropdownMenu = document.createElement('div');
            dropdownMenu.className = 'dropdown-menu';
            dropdownMenu.style.display = 'none';  // 默认隐藏

            // 添加重命名按钮
            var renameButton = document.createElement('button');
            renameButton.textContent = 'Rename';
            renameButton.className = 'rename-button';
            dropdownMenu.appendChild(renameButton);

            // 添加删除按钮
            var deleteButton = document.createElement('button');
            deleteButton.textContent = 'Delete';
            deleteButton.className = 'delete-button';
            dropdownMenu.appendChild(deleteButton);

            listItem.appendChild(dropdownMenu);

            // 显示/隐藏下拉菜单
            optionsButton.addEventListener('click', function (event) {
                event.stopPropagation();  // 阻止事件冒泡
                dropdownMenu.style.display = dropdownMenu.style.display === 'none' ? 'block' : 'none';
            });

            // 点击删除按钮时执行删除操作
            deleteButton.addEventListener('click', function () {
                if (confirm(`确认删除 ${codeName} 吗?`)) {
                    listItem.remove();
                    deleteCodeFromServer(codeName);  // 你需要实现的函数，用于从服务器删除
                }
            });

            // 点击重命名按钮时执行重命名操作
            renameButton.addEventListener('click', function () {
                var newName = prompt("Please enter a new filename:", codeName);
                if (newName && newName !== codeName) {
                    renameCodeOnServer(codeName, newName).then(success => {
                        if (success) {
                            textSpan.textContent = newName;  // 更新UI中的文件名
                            codeName = newName;  // 更新变量中的文件名
                        } else {
                            alert("Rename failures!");
                        }
                    });
                }
            });

            // 点击其他地方时隐藏下拉菜单
            document.addEventListener('click', function () {
                dropdownMenu.style.display = 'none';
            });

            listItem.addEventListener('click', function () {
                // 取消其他项的选中状态
                document.querySelectorAll('.code-item').forEach(function (item) {
                    item.classList.remove('selected');
                });
                // 为当前项添加选中状态
                listItem.classList.add('selected');
                var codeName = textSpan.textContent.trim();
                displayCode(codeName);  // 显示代码内容
            });

            codeList.appendChild(listItem);
        }


        function renameCodeOnServer(oldName, newName) {
            return fetch('/rename-code', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `old_name=${encodeURIComponent(oldName)}&new_name=${encodeURIComponent(newName)}`
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        return true;
                    } else {
                        console.error('Error renaming code:', data.error);
                        return false;
                    }
                })
                .catch(error => {
                    console.error('Error renaming code:', error);
                    return false;
                });
        }


        document.addEventListener('DOMContentLoaded', function () {
            // 处理文件上传
            document.getElementById('upload-button').addEventListener('click', function () {
                // 触发文件选择
                document.getElementById('codeFile').click();
            });

            document.getElementById('codeFile').addEventListener('change', function () {
                // 获取选择的文件
                var file = this.files[0];
                if (file) {
                    var formData = new FormData();
                    formData.append('codeFile', file);

                    // 发送文件到服务器
                    fetch('/upload-code', {
                        method: 'POST',
                        body: formData
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // 添加代码名称到左侧列表
                                addListItem(data.codeName); // 使用函数添加列表项和事件监听器
                            } else {
                                alert('上传失败: ' + data.message);
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                        });
                }
            });

            // 绑定事件监听器到已存在的列表项
            document.querySelectorAll('#code-list li').forEach(function (listItem) {
                listItem.addEventListener('click', function () {
                    displayCode(listItem.textContent);
                });
            });
        });

        document.addEventListener('DOMContentLoaded', function () {
            var codeListItems = document.querySelectorAll('.code-list ul li');

            codeListItems.forEach(function (item) {
                item.addEventListener('click', function () {
                    // 移除所有列表项的选中状态
                    codeListItems.forEach(function (i) {
                        i.classList.remove('selected');
                    });
                    // 为当前点击的项添加选中状态
                    item.classList.add('selected');
                });
            });
        });


        document.addEventListener('DOMContentLoaded', function () {
            // 获取并显示所有已上传的代码
            function loadAndDisplayAllCodes() {
                fetch('/get-all-codes')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();  // 获取所有代码名称的列表
                    })
                    .then(codes => {
                        var codeList = document.getElementById('code-list');
                        codes.forEach(function (codeName) {
                            addListItem(codeName);  // 使用之前定义的函数添加到列表
                        });
                    })
                    .catch(error => {
                        console.error('Error fetching all codes:', error);
                    });
            }

            loadAndDisplayAllCodes();  // 调用函数加载并显示所有代码
        });


        document.getElementById('clear-code-button').addEventListener('click', function () {
            codeEditor.setValue('');
        });

        document.getElementById('download-gcode').addEventListener('click', function () {
            var selectedElement = document.querySelector('.code-item.selected');
            if (selectedElement) {
                var codeName = selectedElement.querySelector('span').textContent.trim();
                console.log('Selected code name:', codeName);

                fetch('/download-gcode', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ name: codeName })
                })
                    .then(response => {
                        console.log('Response status:', response.status);
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.blob();
                    })
                    .then(blob => {
                        console.log('Blob received, initiating download...');

                        // 创建一个a标签并触发点击事件
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.style.display = 'none';
                        a.href = url;
                        a.download = `${codeName.replace(/\.gcode$/, '')}.gcode`; // 确保文件名只有一个.gcode扩展名
                        document.body.appendChild(a);
                        a.click();  // 触发点击事件以打开“另存为”对话框
                        window.URL.revokeObjectURL(url);  // 释放内存
                        document.body.removeChild(a);
                    })
                    .catch(error => console.error('Error downloading the file:', error));
            } else {
                console.error('No GCode file selected.');
                alert('请先选择一个GCode文件。');
            }
        });








        // document.addEventListener('DOMContentLoaded', function () {
        //     document.getElementById('code-list').addEventListener('contextmenu', function (event) {
        //         event.preventDefault();  // 阻止默认的右键菜单
        //         var codeName = event.target.textContent;
        //         if (confirm(`Are you sure you want to delete ${codeName}?`)) {
        //             // 发送删除请求到后端
        //             fetch('/delete-code', {
        //                 method: 'POST',
        //                 headers: {
        //                     'Content-Type': 'application/x-www-form-urlencoded',
        //                 },
        //                 body: `name=${encodeURIComponent(codeName)}`
        //             })
        //                 .then(response => response.json())
        //                 .then(data => {
        //                     if (data.success) {
        //                         // 从页面上移除列表项
        //                         event.target.remove();
        //                         alert(data.message);  // 显示删除成功的消息
        //                     } else {
        //                         alert(data.error);  // 显示错误消息
        //                     }
        //                 })
        //                 .catch(error => {
        //                     console.error('Error deleting code:', error);
        //                 });
        //         }
        //     });
        // });
        function deleteCodeFromServer(codeName) {
            fetch('/delete-code', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `name=${encodeURIComponent(codeName)}`
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(`${codeName} Successfully deleted`);
                    } else {
                        alert(`Failed to delete: ${data.error}`);
                    }
                })
                .catch(error => {
                    console.error('Error deleting code:', error);
                });
        }

        // 函数来处理代码保存
        function saveCode() {

            var selectedElement = document.querySelector('#code-list .selected');
            if (!selectedElement) {
                alert('No code is selected. Please select a code to save.');
                return;
            }

            var codeName = selectedElement.querySelector('span').textContent.trim();
            var newContent = codeEditor.getValue(); // 获取编辑器中的代码内容

            console.log('Code name:', codeName);  // 输出当前正在保存的代码名称
            console.log('Code content:', newContent);  // 输出当前代码内容

            fetch(`/save-code?name=${encodeURIComponent(codeName)}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ new_content: newContent })
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        alert('Code saved successfully');
                    } else {
                        alert('Failed to save code: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error saving code:', error);
                });
        }

        // 绑定保存按钮事件监听器
        document.getElementById('save-code').addEventListener('click', function () {
            console.log('save button clicked')
            saveCode();
        });

        // 绑定保存按钮事件监听器
        // document.getElementById('save-code').addEventListener('click', function () {
        //     var codeName = document.querySelector('#code-list .selected').textContent; // 获取当前选中的代码名称
        //     var newContent = document.getElementById('code-editor').value; // 获取编辑后的代码内容
        //     // var newContent = codeEditor.getValue(); // 获取编辑后的代码内容
        //     saveCode(codeName, newContent); // 保存代码
        // });

        document.getElementById('view-3d-button').addEventListener('click', function () {
            // var codeEditor = document.getElementById('code-editor');
            var gcode = codeEditor.getValue();

            const viewerContainer = document.getElementById('visualization-container'); // 修改此处
            viewerContainer.innerHTML = ''; // 清除先前内容

            // window.onload = function () {
            //     const container = document.getElementById('visualization-container');
            //     viewerContainer.innerHTML = ''; // 清除先前内容
            //     const viewer = new GCodeViewer(container);
            // };

            const viewer = new GCodeViewer(viewerContainer);
            viewer.loadGCode(gcode);

            document.getElementById('visualization-modal').style.display = 'block'; // 修改此处
        });

        document.getElementById('close-visualization-modal').addEventListener('click', function () { // 修改此处
            document.getElementById('visualization-modal').style.display = 'none'; // 修改此处
        });


        class GCodeViewer {
            constructor(container) {
                this.container = container;
                this.scene = new THREE.Scene();
                this.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                this.renderer = new THREE.WebGLRenderer();
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.container.appendChild(this.renderer.domElement);

                // 设置OrbitControls
                this.controls = new THREE.OrbitControls(this.camera, this.renderer.domElement);
                this.controls.enableDamping = true;
                this.controls.dampingFactor = 0.25;
                this.controls.enableZoom = true;

                window.addEventListener('resize', this.onWindowResize.bind(this), false);

                // 创建带箭头的XYZ坐标系
                this.createAxesWithLabels();
            }

            onWindowResize() {
                this.camera.aspect = window.innerWidth / window.innerHeight;
                this.camera.updateProjectionMatrix();
                this.renderer.setSize(window.innerWidth, window.innerHeight);
            }

            // 创建带箭头的 XYZ 坐标轴，并加上标签
            createAxesWithLabels() {
                // 创建 X 轴箭头
                const xArrow = new THREE.ArrowHelper(new THREE.Vector3(1, 0, 0), new THREE.Vector3(0, 0, 0), 30, 0xff0000, 10, 3); // 红色箭头
                this.scene.add(xArrow);

                // 创建 Y 轴箭头
                const yArrow = new THREE.ArrowHelper(new THREE.Vector3(0, 1, 0), new THREE.Vector3(0, 0, 0), 30, 0x00ff00, 10, 3); // 绿色箭头
                this.scene.add(yArrow);

                // 创建 Z 轴箭头
                const zArrow = new THREE.ArrowHelper(new THREE.Vector3(0, 0, 1), new THREE.Vector3(0, 0, 0), 30, 0x0000ff, 10, 3); // 蓝色箭头
                this.scene.add(zArrow);

                // 添加X轴标签
                this.addAxisLabel('X', new THREE.Vector3(30, 0, 0), 0xff0000);
                // 添加Y轴标签
                this.addAxisLabel('Y', new THREE.Vector3(0, 30, 0), 0x00ff00);
                // 添加Z轴标签
                this.addAxisLabel('Z', new THREE.Vector3(0, 0, 30), 0x0000ff);
            }

            // 添加轴标签的函数
            addAxisLabel(labelText, position, color) {
                const loader = new THREE.FontLoader();
                loader.load('https://threejs.org/examples/fonts/helvetiker_regular.typeface.json', (font) => {
                    const textGeometry = new THREE.TextGeometry(labelText, {
                        font: font,
                        size: 3, // 字体大小
                        height: 1, // 厚度
                    });
                    const textMaterial = new THREE.MeshBasicMaterial({ color: color });
                    const textMesh = new THREE.Mesh(textGeometry, textMaterial);
                    textMesh.position.copy(position);
                    this.scene.add(textMesh);
                });
            }

            loadGCode(gcode) {
                const lines = gcode.split('\n');
                const material = new THREE.LineBasicMaterial({ color: 0xffffff, linewidth: 2 });
                const geometry = new THREE.BufferGeometry();
                const vertices = [];

                let lastX = 0, lastY = 0, lastZ = 0;

                lines.forEach(line => {
                    if (line.startsWith('G1') || line.startsWith('G0')) {
                        const parts = line.split(' ');
                        let x = lastX, y = lastY, z = lastZ;
                        parts.forEach(part => {
                            if (part.startsWith('X')) x = parseFloat(part.substring(1));
                            if (part.startsWith('Y')) y = parseFloat(part.substring(1));
                            if (part.startsWith('Z')) z = parseFloat(part.substring(1));
                        });
                        if (!isNaN(x) && !isNaN(y) && !isNaN(z)) {
                            vertices.push(x, y, z);
                            lastX = x;
                            lastY = y;
                            lastZ = z;
                        }
                    }
                });

                if (vertices.length > 0) {
                    geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
                    const line = new THREE.Line(geometry, material);
                    this.scene.add(line);

                    // 调用 fitCameraToObject 来调整摄像机
                    this.fitCameraToObject(line);
                } else {
                    console.error("未找到有效的顶点数据。");
                }

                this.animate();
            }

            animate() {
                requestAnimationFrame(this.animate.bind(this));
                this.controls.update();
                this.renderer.render(this.scene, this.camera);
            }

            // 定义 fitCameraToObject 函数
            fitCameraToObject(object, offset = 1.5) {
                const boundingBox = new THREE.Box3().setFromObject(object);
                const center = boundingBox.getCenter(new THREE.Vector3());
                const size = boundingBox.getSize(new THREE.Vector3());

                const maxDim = Math.max(size.x, size.y, size.z);
                const fov = this.camera.fov * (Math.PI / 180);
                let cameraZ = Math.abs(maxDim / 2 * Math.tan(fov / 2)) * offset;

                this.camera.position.z = cameraZ;

                const minZ = boundingBox.min.z;
                const cameraToFarEdge = minZ < 0 ? -minZ + cameraZ : cameraZ;

                this.camera.far = cameraToFarEdge * 3;
                this.camera.updateProjectionMatrix();

                this.controls.target.set(center.x, center.y, center.z);
                this.controls.update();
            }
        }





        document.addEventListener('DOMContentLoaded', function () {
            var closeVisualizationBtn = document.getElementById('close-visualization-modal');
            closeVisualizationBtn.onclick = function () {
                document.getElementById('visualization-modal').style.display = 'none';
            };
        });

        function adjustVisualizationHeight() {
            const modalContent = document.querySelector('.visualization-modal-content');
            const navigationBarHeight = document.querySelector('.fixed-bottom-bar').offsetHeight;
            const availableHeight = window.innerHeight - navigationBarHeight - 20; // 留出一定间隔
            modalContent.style.height = availableHeight + 'px';
        }

        // 页面加载时调整高度
        document.addEventListener('DOMContentLoaded', function () {
            adjustVisualizationHeight();
        });

        // 当窗口大小变化时也调整高度
        window.addEventListener('resize', adjustVisualizationHeight);



        // 人工客服
        document.querySelectorAll('#customer-service-modal .faq-question').forEach(function (question) {
            question.addEventListener('click', function () {
                var answer = this.nextElementSibling;
                answer.style.display = answer.style.display === 'none' ? 'block' : 'none';
            });
        });

        // 添加联系表单的提交逻辑（示例）
        document.getElementById('contact-form').addEventListener('submit', function (e) {
            e.preventDefault();
            // 在这里处理表单提交，例如发送AJAX请求或显示确认消息
            alert('表单已提交！');
        });

        //ai-chat
        document.getElementById('send-message').addEventListener('click', function () {
            var input = document.getElementById('chat-input');
            var message = input.value;
            input.value = ''; // 清空输入框

            // 将消息添加到聊天记录
            var chatHistory = document.getElementById('chat-history');
            var newMessage = document.createElement('div');
            newMessage.textContent = message;
            chatHistory.appendChild(newMessage);

            // 这里可以添加调用AI聊天接口的逻辑
            // ...
        });



        document.addEventListener('DOMContentLoaded', function () {
            var faqQuestions = document.querySelectorAll('.faq-question');

            faqQuestions.forEach(function (question) {
                question.addEventListener('click', function () {
                    this.classList.toggle("active");
                    var answer = this.nextElementSibling;
                    if (answer.style.display === "block") {
                        answer.style.display = "none";
                    } else {
                        answer.style.display = "block";
                    }
                });
            });
        });


        document.getElementById('search-form').addEventListener('submit', function (e) {
            e.preventDefault(); // 阻止表单默认提交行为

            var searchText = document.getElementById('search-input').value;
            console.log('搜索内容：', searchText);

            // 在这里添加搜索逻辑，例如发送AJAX请求或者使用表单提交
        });

        // 获取模态框元素
        var customerServiceModal = document.getElementById("customer-service-modal");
        var aiChatModal = document.getElementById("AI-chat-modal");
        var helpServiceModal = document.getElementById("help-service-modal")
        var settingModal = document.getElementById("setting-modal")
        var monitoringModal = document.getElementById("monitoring-modal")
        var searchModal = document.getElementById("search-modal")

        // 获取打开模态框的按钮元素
        var customerServiceBtn = document.getElementById("customer-service-button");
        var aiChatBtn = document.getElementById("AI-chat-button");
        var helpServiceBtn = document.getElementById("help-service-button")
        var settingBtn = document.getElementById("setting-button")
        var monitoringBtn = document.getElementById("monitoring-button")
        var searchBtn = document.getElementById("search-button")

        // 获取模态框内的所有关闭按钮元素
        var closeButtons = document.getElementsByClassName("close-button");

        // 点击按钮时打开对应的模态框
        customerServiceBtn.onclick = function () {
            customerServiceModal.style.display = "block";
        }

        aiChatBtn.onclick = function () {
            aiChatModal.style.display = "block";
        }

        settingBtn.onclick = function () {
            settingModal.style.display = "block";
        }

        monitoringBtn.onclick = function () {
            monitoringModal.style.display = "block";
        }

        helpServiceBtn.onclick = function () {
            helpServiceModal.style.display = "block";
        }

        searchBtn.onclick = function () {
            searchModal.style.display = "block";
        }

        // 为每个关闭按钮添加点击事件监听器
        for (var i = 0; i < closeButtons.length; i++) {
            closeButtons[i].onclick = function () {
                // 这里我们可以关闭这个按钮所在的模态框
                this.closest('.modal').style.display = 'none';
            }
        }

        // 点击模态框外任何地方关闭模态框
        window.onclick = function (event) {
            if (event.target == customerServiceModal) {
                customerServiceModal.style.display = "none";
            }
            if (event.target == aiChatModal) {
                aiChatModal.style.display = "none";
            }
            if (event.target == helpServiceModal) {
                helpServiceModal.style.display = "none";
            }
            if (event.target == settingModal) {
                settingModal.style.display = "none";
            }
            if (event.target == monitoringModal) {
                monitoringModal.style.display = "none";
            }
            if (event.target == searchModal) {
                searchModal.style.display = "none";
            }
        }

    </script>

</body>

</html>